<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pathwise</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --ink-dim:#465066;
    --muted:#6b7280; --ring:rgba(2,132,199,.25);
    --primary:#0a84ff; --primary-ink:#fff;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --chip:#eef2ff; --chip-ink:#334155;
    --line:#e5e7eb; --shadow:0 6px 28px rgba(15,23,42,.06);
    --radius:16px; --radius-sm:12px;
  }
  [data-theme="dark"]{
    --bg:#0b1020; --card:#0f1528; --ink:#e6eaf6; --ink-dim:#b8c0d9;
    --muted:#9aa3b2; --ring:rgba(10,132,255,.3);
    --chip:#142340; --chip-ink:#cbd5e1;
    --line:#1d2948; --shadow:0 8px 28px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family: ui-sans-serif,system-ui,-apple-system,"SF Pro",Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:24px auto 96px;padding:0 16px}
  header.app{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;margin-bottom:8px;position:sticky;top:0;background:color-mix(in oklab,var(--bg) 88%, transparent);backdrop-filter: blur(8px);z-index:50;border-bottom:1px solid var(--line)}
  .brand{font-weight:800;letter-spacing:.5px}
  .seg{display:flex;gap:8px;flex-wrap:wrap}
  .seg__btn{border:1px solid var(--line);background:var(--card);color:var(--ink);padding:8px 14px;border-radius:999px;cursor:pointer;box-shadow:var(--shadow);transition:.2s}
  .seg__btn.is-active{background:var(--ink);color:var(--card)}
  .right{display:flex;gap:8px;align-items:center}
  .btn{border:1px solid var(--line);background:var(--card);color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s;box-shadow:var(--shadow)}
  .btn:hover{transform:translateY(-1px)}
  .btn--primary{background:var(--primary);color:var(--primary-ink);border-color:transparent}
  .btn--danger{background:var(--bad);color:#fff;border-color:transparent}
  .btn--ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}
  .btn--quiet{background:transparent;border:1px dashed var(--line);color:var(--muted)}
  .hidden{display:none!important}
  .chips{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
  .chip{background:var(--chip);color:var(--chip-ink);border:1px solid var(--line);padding:6px 10px;border-radius:999px;cursor:pointer}
  .chip.is-on{outline:2px solid var(--ring)}

  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);margin:12px 0}
  .row{display:flex;align-items:center;gap:12px;justify-content:space-between}
  .sub{color:var(--muted);font-size:.9rem}
  .hr{height:1px;background:var(--line);margin:10px 0}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (max-width:720px){.grid-2{grid-template-columns:1fr}}

  .scard{background:var(--card);border:1px solid var(--line);border-radius:var(--radius-sm);padding:14px;box-shadow:var(--shadow)}
  .meta{color:var(--muted);font-size:.9rem;margin:4px 0}
  .pill{padding:6px 10px;border-radius:999px;font-size:.85rem;font-weight:700}
  .pill--reach{background:color-mix(in oklab,var(--bad) 15%, transparent);color:var(--bad)}
  .pill--match{background:color-mix(in oklab,var(--warn) 15%, transparent);color:var(--warn)}
  .pill--safe{background:color-mix(in oklab,var(--ok) 15%, transparent);color:var(--ok)}
  .tag{border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:.8rem;color:var(--muted)}

  .statwrap{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .stat{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .stat .k{color:var(--muted);font-weight:600}
  .stat .v{font-size:2rem;font-weight:800;color:var(--ink)}

  .input,.select{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--line);background:var(--card);color:var(--ink)}
  .label{color:var(--muted);font-size:.85rem;margin-bottom:6px}

  .tline{display:flex;flex-direction:column;gap:8px}
  .titem{padding:12px;border-radius:12px;border:1px solid var(--line);background:color-mix(in oklab,var(--primary) 9%, transparent)}
  .titem--warn{background:color-mix(in oklab,var(--warn) 12%, transparent)}
  .titem--danger{background:color-mix(in oklab,var(--bad) 15%, transparent)}

  .chk{display:flex;align-items:center;gap:12px;border:1px dashed var(--line);border-radius:12px;padding:10px;margin:6px 0}
  .chk input{transform:scale(1.2)}

  /* AI button */
  .ai{position:fixed;right:18px;bottom:18px;width:54px;height:54px;border-radius:50%;background:var(--primary);color:#fff;border:none;box-shadow:0 12px 28px rgba(10,132,255,.38);cursor:pointer;font-size:22px;display:grid;place-items:center}
  .ai:after{content:"";position:absolute;inset:-8px;border-radius:inherit;border:2px solid color-mix(in oklab,var(--primary) 30%, transparent);animation:pulse 2.4s infinite}
  @keyframes pulse{0%{opacity:.8;transform:scale(1)}70%{opacity:0;transform:scale(1.45)}100%{opacity:0}}
  .toast{position:fixed;right:86px;bottom:18px;max-width:360px;background:var(--card);border:1px solid var(--line);box-shadow:var(--shadow);padding:12px 14px;border-radius:12px}
</style>
</head>
<body>
  <header class="app">
    <div class="brand">Pathwise</div>
    <div id="seg" class="seg">
      <button class="seg__btn is-active" data-tab="dash">Dashboard</button>
      <button class="seg__btn" data-tab="schools">Schools</button>
      <button class="seg__btn" data-tab="aid">Aid</button>
      <button class="seg__btn" data-tab="docs">Docs</button>
      <button id="editPlanBtn" class="seg__btn" data-tab="plan">Edit Planning</button>
    </div>
    <div class="right">
      <button id="themeBtn" class="btn">Theme</button>
      <button id="resetAllBtn" class="btn btn--danger" title="Starts fresh">Reset</button>
    </div>
  </header>

  <div class="wrap">
    <!-- summary chips -->
    <div id="chips" class="chips">
      <div id="sumHome" class="chip">Home: —</div>
      <div id="sumFocus" class="chip">Focus: —</div>
      <div id="sumGPA" class="chip">GPA: —</div>
    </div>

    <!-- Planning -->
    <section id="view-plan" class="card hidden">
      <h2>Let's plan your path</h2>
      <div class="hr"></div>
      <div id="step1">
        <div class="grid-2">
          <div>
            <div class="label">First name</div>
            <input id="pName" class="input" placeholder="Alex" />
            <div id="nameErr" class="sub" style="color:var(--bad);display:none;margin-top:6px">Please enter your name.</div>
          </div>
          <div>
            <div class="label">Home state</div>
            <select id="pState" class="select"></select>
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <div class="sub">We’ll use your state to set resident vs. non-resident tuition automatically.</div>
          <button id="to2" class="btn btn--primary">Continue</button>
        </div>
      </div>

      <div id="step2" class="hidden">
        <div class="grid-2">
          <div>
            <div class="label">GPA (optional)</div>
            <input id="pGPA" class="input" type="number" min="0" max="5" step=".01" placeholder="e.g., 3.75" />
          </div>
          <div>
            <div class="label">SAT (optional)</div>
            <input id="pSAT" class="input" type="number" min="400" max="1600" step="10" placeholder="e.g., 1400" />
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="back1" class="btn">Back</button>
          <button id="to3" class="btn btn--primary">Continue</button>
        </div>
      </div>

      <div id="step3" class="hidden">
        <div class="label">Interests (pick a few)</div>
        <div id="interestSel" class="chips" style="margin-bottom:12px"></div>

        <div class="label">What matters most?</div>
        <div id="prefSel" class="chips"></div>

        <div class="row" style="margin-top:12px">
          <button id="back2" class="btn">Back</button>
          <button id="to4" class="btn btn--primary">Continue</button>
        </div>
      </div>

      <div id="step4" class="hidden">
        <div class="sub">You're set. Save this and start picking schools.</div>
        <div class="row" style="margin-top:12px">
          <button id="back3" class="btn">Back</button>
          <button id="finishPlan" class="btn btn--primary">Save & Go</button>
        </div>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="view-dash" class="card hidden">
      <div class="row">
        <h2 id="helloName">Welcome back</h2>
        <button id="addSchoolsBtn" class="btn btn--primary">Add Schools</button>
      </div>
      <div class="statwrap" style="margin-top:8px">
        <div class="stat">
          <div class="k">Your GPA</div>
          <div id="statGPA" class="v">—</div>
        </div>
        <div class="stat">
          <div class="k">Target schools</div>
          <div id="statCount" class="v">0</div>
        </div>
        <div class="stat">
          <div class="k">Days to UC/CSU deadline</div>
          <div id="statDays" class="v">—</div>
        </div>
      </div>
      <!-- dashboard school cards & timeline inserted here -->
    </section>

    <!-- Schools -->
    <section id="view-schools" class="hidden">
      <div class="card">
        <div class="row">
          <h2>Pick schools</h2>
          <button id="commitPicks" class="btn btn--primary">Add Selected</button>
        </div>
        <div id="schoolGrid" class="grid" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- Aid -->
    <section id="view-aid" class="hidden">
      <div class="card">
        <h2>Financial Aid</h2>
        <div id="aidPanel"></div>
      </div>
    </section>

    <!-- Docs -->
    <section id="view-docs" class="hidden">
      <div class="card">
        <h2>Documents</h2>
        <div id="docsPanel" style="margin-top:8px"></div>
      </div>
    </section>
  </div>

  <!-- AI button -->
  <button id="aiBtn" class="ai" title="Need help?">🤖</button>
  <div id="toast" class="toast hidden"></div>

<script>
/* =========================
   School data (CA focused)
   ========================= */
const SCHOOLS = {
  "UC Berkeley": {
    id:"ucb", state:"CA", system:"UC", public:true, private:false,
    avgGPA:4.25, avgSAT:1450,
    tuitionResident:14226, tuitionNonResident:45258,
    weights:{ academics:0.6, eca:0.25, testing:0.15 },
    requirements:[
      {key:"ucApp", label:"UC Application", due:"2025-11-30"},
      {key:"ucPIQ", label:"UC Personal Insight Questions (4)", due:"2025-11-30"},
      {key:"transcript", label:"Official Transcript (post-submit)", due:"2026-07-01"},
    ],
    deadlines:{ open:"2025-08-01", priority:"2025-11-15", final:"2025-11-30" }
  },
  "UCLA": {
    id:"ucla", state:"CA", system:"UC", public:true, private:false,
    avgGPA:4.26, avgSAT:1445,
    tuitionResident:13401, tuitionNonResident:43700,
    weights:{ academics:0.55, eca:0.3, testing:0.15 },
    requirements:[
      {key:"ucApp", label:"UC Application", due:"2025-11-30"},
      {key:"ucPIQ", label:"UC Personal Insight Questions (4)", due:"2025-11-30"},
    ],
    deadlines:{ open:"2025-08-01", priority:"2025-11-15", final:"2025-11-30" }
  },
  "UC San Diego": {
    id:"ucsd", state:"CA", system:"UC", public:true, private:false,
    avgGPA:4.16, avgSAT:1410,
    tuitionResident:14616, tuitionNonResident:45879,
    weights:{ academics:0.6, eca:0.25, testing:0.15 },
    requirements:[
      {key:"ucApp", label:"UC Application", due:"2025-11-30"},
      {key:"ucPIQ", label:"UC Personal Insight Questions (4)", due:"2025-11-30"},
    ],
    deadlines:{ open:"2025-08-01", priority:"2025-11-15", final:"2025-11-30" }
  },
  "UC Davis": {
    id:"ucd", state:"CA", system:"UC", public:true, private:false,
    avgGPA:4.13, avgSAT:1350,
    tuitionResident:14597, tuitionNonResident:45672,
    weights:{ academics:0.55, eca:0.3, testing:0.15 },
    requirements:[
      {key:"ucApp", label:"UC Application", due:"2025-11-30"},
      {key:"ucPIQ", label:"UC Personal Insight Questions (4)", due:"2025-11-30"},
    ],
    deadlines:{ open:"2025-08-01", priority:"2025-11-15", final:"2025-11-30" }
  },
  "UC Irvine": {
    id:"uci", state:"CA", system:"UC", public:true, private:false,
    avgGPA:4.08, avgSAT:1360,
    tuitionResident:13727, tuitionNonResident:45200,
    weights:{ academics:0.55, eca:0.3, testing:0.15 },
    requirements:[
      {key:"ucApp", label:"UC Application", due:"2025-11-30"},
      {key:"ucPIQ", label:"UC Personal Insight Questions (4)", due:"2025-11-30"},
    ],
    deadlines:{ open:"2025-08-01", priority:"2025-11-15", final:"2025-11-30" }
  },
  "UC Santa Barbara": {
    id:"ucsb", state:"CA", system:"UC", public:true, private:false,
    avgGPA:4.15, avgSAT:1380,
    tuitionResident:14391, tuitionNonResident:45200,
    weights:{ academics:0.55, eca:0.3, testing:0.15 },
    requirements:[
      {key:"ucApp", label:"UC Application", due:"2025-11-30"},
      {key:"ucPIQ", label:"UC Personal Insight Questions (4)", due:"2025-11-30"},
    ],
    deadlines:{ open:"2025-08-01", priority:"2025-11-15", final:"2025-11-30" }
  },
  "UC Santa Cruz": {
    id:"ucsc", state:"CA", system:"UC", public:true, private:false,
    avgGPA:3.96, avgSAT:1295,
    tuitionResident:13991, tuitionNonResident:43200,
    weights:{ academics:0.5, eca:0.3, testing:0.2 },
    requirements:[
      {key:"ucApp", label:"UC Application", due:"2025-11-30"},
      {key:"ucPIQ", label:"UC Personal Insight Questions (4)", due:"2025-11-30"},
    ],
    deadlines:{ open:"2025-08-01", priority:"2025-11-15", final:"2025-11-30" }
  },
  "San Diego State": {
    id:"sdsu", state:"CA", system:"CSU", public:true, private:false,
    avgGPA:3.85, avgSAT:1270,
    tuitionResident:7720, tuitionNonResident:19700,
    weights:{ academics:0.5, eca:0.35, testing:0.15 },
    requirements:[
      {key:"csuApp", label:"CSU Application", due:"2025-11-30"},
    ],
    deadlines:{ open:"2025-10-01", priority:"2025-11-15", final:"2025-11-30" }
  },
  "Cal Poly SLO": {
    id:"cpslo", state:"CA", system:"CSU", public:true, private:false,
    avgGPA:4.06, avgSAT:1395,
    tuitionResident:10377, tuitionNonResident:24500,
    weights:{ academics:0.5, eca:0.35, testing:0.15 },
    requirements:[
      {key:"csuApp", label:"CSU Application", due:"2025-11-30"},
      {key:"majorSupp", label:"Major-specific portfolio (if arch/art)", due:"2025-11-15"},
    ],
    deadlines:{ open:"2025-10-01", priority:"2025-11-15", final:"2025-11-30" }
  },
  "USC": {
    id:"usc", state:"CA", system:"Private", public:false, private:true,
    avgGPA:3.9, avgSAT:1500,
    tuitionResident:68300, tuitionNonResident:68300,
    weights:{ academics:0.55, eca:0.35, testing:0.10 },
    requirements:[
      {key:"common", label:"Common App", due:"2025-01-15"},
      {key:"uscSupp", label:"USC Supplement", due:"2025-01-15"},
      {key:"recs", label:"2 Teacher Letters", due:"2024-12-15"},
    ],
    deadlines:{ ed:null, rd:"2025-01-15" }
  },
  "Stanford": {
    id:"stanford", state:"CA", system:"Private", public:false, private:true,
    avgGPA:4.18, avgSAT:1520,
    tuitionResident:61650, tuitionNonResident:61650,
    weights:{ academics:0.55, eca:0.35, testing:0.10 },
    requirements:[
      {key:"common", label:"Common App", due:"2025-01-05"},
      {key:"stanSupp", label:"Stanford Supplement", due:"2025-01-05"},
      {key:"recs", label:"2 Teacher Letters", due:"2024-12-15"},
    ],
    deadlines:{ ed:"2024-11-01", rd:"2025-01-05" }
  }
};

/* =========================
   Storage + helpers
   ========================= */
const K = { PLAN:"pw_plan", PICKS:"pw_picks", DOCS:"pw_docs", THEME:"pw_theme" };
const get = (k,fb)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? fb }catch{return fb} };
const set = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
const del = k=>localStorage.removeItem(k);

/* =========================
   Theme + Reset
   ========================= */
(function initTheme(){
  const t = get(K.THEME,"light");
  document.documentElement.setAttribute("data-theme", t);
})();
document.getElementById("themeBtn").onclick = ()=>{
  const cur = document.documentElement.getAttribute("data-theme");
  const next = cur==="dark"?"light":"dark";
  document.documentElement.setAttribute("data-theme", next);
  set(K.THEME,next);
};
document.getElementById("resetAllBtn").onclick = ()=>{
  Object.values(K).forEach(del);
  location.reload();
};

/* =========================
   Planning flow
   ========================= */
const STATES = ["CA","NY","TX","MA","IL","WA","FL","AZ","CO","NC","GA","PA","VA","MD","OR","MI","OH","NJ","CT","UT"];
const pState = document.getElementById("pState");
function fillStates(){ if(!pState.options.length){ STATES.forEach(s=>{ const o=document.createElement("option"); o.value=s; o.textContent=s; pState.appendChild(o); }); } }
fillStates();

const INTERESTS = ["STEM","CS/AI","Business","Arts","Health","Humanities","Education","Social Science","Design"];
const PREFS = [
  {k:"reputation",label:"School reputation"},
  {k:"cost",label:"Affordability"},
  {k:"location",label:"Close to home"},
  {k:"size",label:"Campus size"},
];
const interestSel = document.getElementById("interestSel");
const prefSel = document.getElementById("prefSel");
function fillChips(){
  if(!interestSel.children.length){
    INTERESTS.forEach(i=>{ const b=document.createElement("button"); b.type="button"; b.className="chip"; b.textContent=i; b.onclick=()=>b.classList.toggle("is-on"); interestSel.appendChild(b); });
  }
  if(!prefSel.children.length){
    PREFS.forEach(p=>{ const b=document.createElement("button"); b.type="button"; b.className="chip"; b.textContent=p.label; b.dataset.key=p.k; b.onclick=()=>b.classList.toggle("is-on"); prefSel.appendChild(b); });
  }
}
fillChips();

const steps = ["step1","step2","step3","step4"].map(id=>document.getElementById(id));
function showStep(i){ steps.forEach((s,idx)=>s.classList.toggle("hidden",idx!==i)); }
document.getElementById("to2").onclick = ()=>{
  const name = document.getElementById("pName").value.trim();
  if(!name){ document.getElementById("nameErr").style.display="block"; return; }
  document.getElementById("nameErr").style.display="none";
  showStep(1);
};
document.getElementById("to3").onclick = ()=>showStep(2);
document.getElementById("to4").onclick = ()=>showStep(3);
document.getElementById("back1").onclick = ()=>showStep(0);
document.getElementById("back2").onclick = ()=>showStep(1);
document.getElementById("back3").onclick = ()=>showStep(2);

document.getElementById("finishPlan").onclick = ()=>{
  const prefs = Array.from(prefSel.querySelectorAll(".is-on")).map(b=>b.dataset.key);
  const ints  = Array.from(interestSel.querySelectorAll(".is-on")).map(b=>b.textContent);
  const plan = {
    name: document.getElementById("pName").value.trim(),
    state: document.getElementById("pState").value || "CA",
    gpa:  parseFloat(document.getElementById("pGPA").value)||null,
    sat:  parseInt(document.getElementById("pSAT").value)||null,
    interests: ints, prefs
  };
  set(K.PLAN, plan);
  if(!get(K.PICKS,null)) set(K.PICKS, []);
  route("dash");
};
document.getElementById("editPlanBtn").onclick = ()=>route("plan");

/* =========================
   Routing + summary chips
   ========================= */
function setActive(tab){
  document.querySelectorAll('#seg .seg__btn').forEach(b=>b.classList.toggle('is-active', b.dataset.tab===tab));
}
function updateSummary(){
  const plan=get(K.PLAN,null);
  const sHome=document.getElementById("sumHome"), sFocus=document.getElementById("sumFocus"), sGPA=document.getElementById("sumGPA");
  if(!plan){ sHome.textContent="Home: —"; sFocus.textContent="Focus: —"; sGPA.textContent="GPA: —"; return; }
  sHome.textContent = `Home: ${plan.state}`;
  sFocus.textContent= `Focus: ${plan.prefs?.length? "Balanced" : "—"}`;
  sGPA.textContent  = `GPA: ${plan.gpa ?? "—"}`;
  const hello = document.getElementById("helloName");
  hello.textContent = `Welcome back, ${plan.name||"Student"}`;
}
function route(tab){
  const v={plan:"view-plan", dash:"view-dash", schools:"view-schools", aid:"view-aid", docs:"view-docs"};
  const needPlan=!get(K.PLAN,null);
  if(needPlan && tab!=="plan"){ tab="plan"; }
  Object.values(v).forEach(id=>document.getElementById(id).classList.add("hidden"));
  document.getElementById(v[tab]).classList.remove("hidden");
  setActive(tab);
  document.getElementById("chips").style.display = tab==="plan" ? "none":"flex";
  updateSummary();
  if(tab==="dash"){ renderDashboard(); }
  if(tab==="schools"){ renderSchoolPicker(); }
  if(tab==="aid"){ renderAid(); }
  if(tab==="docs"){ renderDocs(); }
}
document.getElementById("seg").addEventListener("click",(e)=>{
  const b=e.target.closest("[data-tab]"); if(!b) return;
  route(b.dataset.tab);
});

/* =========================
   Calculations & utilities
   ========================= */
function residencyLabel(name){
  const plan=get(K.PLAN,null); const s=SCHOOLS[name];
  if(s.private) return "Private";
  return (s.state===plan.state)?"Resident":"Non-resident";
}
function tuitionFor(name){
  const plan=get(K.PLAN,null); const s=SCHOOLS[name];
  const resident=(s.private || s.state===plan.state);
  return resident ? s.tuitionResident : s.tuitionNonResident;
}
function matchScore(name){
  const plan=get(K.PLAN,null); const s=SCHOOLS[name]; if(!plan) return 50;
  let score=50;
  if(plan.gpa) score += (plan.gpa - s.avgGPA)*22;
  if(plan.sat) score += (plan.sat - s.avgSAT)/12;
  if(plan.prefs?.includes("reputation") && (s.system==="UC"|| s.private)) score += 8;
  if(plan.prefs?.includes("cost") && s.public) score += 8;
  if((plan.interests||[]).some(i=>/CS|STEM|AI/i.test(i)) && /(UC|Cal Poly|Stanford|USC)/.test(name)) score += 8;
  return Math.max(1,Math.min(99,Math.round(score)));
}

/* =========================
   Schools picker
   ========================= */
function renderSchoolPicker(){
  const grid=document.getElementById("schoolGrid"); grid.innerHTML="";
  const selected=new Set(get(K.PICKS,[]));
  Object.keys(SCHOOLS).forEach(name=>{
    const s=SCHOOLS[name]; const score=matchScore(name);
    const cat=score>=70?'pill--safe':score>=50?'pill--match':'pill--reach';
    const card=document.createElement("div"); card.className="scard"; card.innerHTML = `
      <div class="row"><strong>${name}</strong><span class="pill ${cat}">${score}%</span></div>
      <div class="meta">Avg GPA ${s.avgGPA} • SAT ${s.avgSAT} • ${s.public?'Public':'Private'} • ${s.state}</div>
      <div class="row"><div class="sub">Your tuition</div><strong>$${tuitionFor(name).toLocaleString()}</strong> <span class="tag">${residencyLabel(name)}</span></div>
      <footer style="margin-top:8px">
        <button class="btn ${selected.has(name)?'btn--danger':'btn--primary'} pickBtn" data-name="${name}">${selected.has(name)?'Remove':'Add'}</button>
      </footer>
    `;
    grid.appendChild(card);
  });
  grid.onclick=(e)=>{
    const b=e.target.closest(".pickBtn"); if(!b) return;
    const name=b.dataset.name; const picks=new Set(get(K.PICKS,[]));
    picks.has(name) ? picks.delete(name) : picks.add(name);
    set(K.PICKS, Array.from(picks));
    renderSchoolPicker();
  };
  document.getElementById("commitPicks").onclick=()=>route("dash");
}
document.getElementById("addSchoolsBtn").onclick=()=>route("schools");

/* =========================
   Dashboard + Timeline
   ========================= */
function renderDashboard(){
  // stats
  const plan=get(K.PLAN,null);
  document.getElementById("statGPA").textContent = plan?.gpa ? Number(plan.gpa).toFixed(2) : "—";
  const picks=get(K.PICKS,[]);
  document.getElementById("statCount").textContent = picks.length;

  // UC/CSU final deadline days (Nov 30, 2025)
  const deadline=new Date("2025-11-30T23:59:59");
  const days=Math.max(0, Math.ceil((deadline - new Date())/(1000*60*60*24)));
  document.getElementById("statDays").textContent = String(days);

  // container
  const containerId="dashContent";
  let cont=document.getElementById(containerId);
  if(!cont){ cont=document.createElement("div"); cont.id=containerId; document.getElementById("view-dash").appendChild(cont); }
  cont.innerHTML="";
  // schools
  const title=document.createElement("h3"); title.style.marginTop="16px"; title.textContent="Your Schools";
  cont.appendChild(title);
  const grid=document.createElement("div"); grid.className="grid"; cont.appendChild(grid);

  if(!picks.length){
    const empty=document.createElement("div"); empty.className="card"; empty.innerHTML=`<div class="sub">No schools yet. Click “Add Schools”.</div>`;
    cont.appendChild(empty);
  } else {
    picks.forEach(name=>{
      const s=SCHOOLS[name]; const score=matchScore(name);
      const cat=score>=70?'pill--safe':score>=50?'pill--match':'pill--reach';
      const el=document.createElement("div"); el.className="scard"; el.innerHTML=`
        <div class="row"><strong>${name}</strong><span class="pill ${cat}">${score>=70?'Safe':score>=50?'Match':'Reach'} • ${score}%</span></div>
        <div class="meta">Avg GPA ${s.avgGPA} • SAT ${s.avgSAT} • ${s.public?'Public':'Private'} • ${s.state}</div>
        <div class="row"><div class="sub">Your tuition</div><strong>$${tuitionFor(name).toLocaleString()}</strong> <span class="tag">${residencyLabel(name)}</span></div>
        <footer style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn--ghost reqBtn" data-name="${name}">Requirements</button>
          <button class="btn btn--ghost aidBtn" data-name="${name}">Aid</button>
          <button class="btn btn--danger removeBtn" data-name="${name}">Remove</button>
        </footer>
      `;
      grid.appendChild(el);
    });
    grid.onclick=(e)=>{
      const rm=e.target.closest(".removeBtn");
      const rq=e.target.closest(".reqBtn");
      const ad=e.target.closest(".aidBtn");
      if(rm){ const n=rm.dataset.name; set(K.PICKS, get(K.PICKS,[]).filter(x=>x!==n)); renderDashboard(); renderDocs(); renderAid(); renderTimeline(); return; }
      if(rq){ route("docs"); renderDocs(rq.dataset.name); return; }
      if(ad){ route("aid");  renderAid(ad.dataset.name); return; }
    };
  }

  // timeline
  const tlTitle=document.createElement("h3"); tlTitle.style.marginTop="16px"; tlTitle.textContent="Timeline (auto)";
  const tline=document.createElement("div"); tline.className="tline"; tline.id="timeline";
  cont.appendChild(tlTitle); cont.appendChild(tline);
  renderTimeline();
}

function renderTimeline(){
  const t=document.getElementById("timeline"); if(!t) return; t.innerHTML="";
  const picks=get(K.PICKS,[]); if(!picks.length){ t.innerHTML=`<div class="sub">Add schools to see your timeline.</div>`; return; }
  const items=[]; const today=new Date();
  picks.forEach(name=>{
    const s=SCHOOLS[name]; const d=s.deadlines||{};
    ["open","priority","final","ed","rd"].forEach(k=>{ if(d[k]) items.push({date:new Date(d[k]), label:`${name} — ${k.toUpperCase()} deadline`}) });
    (s.requirements||[]).forEach(req=>{ items.push({date:new Date(req.due), label:`${name}: ${req.label}`}) });
  });
  items.sort((a,b)=>a.date-b.date).forEach(it=>{
    const diff=Math.ceil((it.date - today)/(1000*60*60*24));
    const cls=diff<=14?"titem titem--danger":diff<=30?"titem titem--warn":"titem";
    const el=document.createElement("div"); el.className=cls;
    el.innerHTML = `<strong>${it.date.toLocaleDateString(undefined,{month:"short",day:"numeric"})}</strong> — ${it.label} <span class="sub" style="float:right">${diff>0?diff+' days':'due'}</span>`;
    t.appendChild(el);
  });
}

/* =========================
   Docs
   ========================= */
function renderDocs(focusSchool){
  const panel=document.getElementById("docsPanel"); panel.innerHTML="";
  const picks=get(K.PICKS,[]); if(!picks.length){ panel.innerHTML=`<div class="sub">Add schools first.</div>`; return; }
  const docsState=get(K.DOCS,{});
  picks.forEach(name=>{
    const s=SCHOOLS[name];
    const block=document.createElement("div"); block.className="card"; block.style.marginBottom="8px";
    block.innerHTML=`<div class="row"><strong>${name}</strong><span class="tag">${s.system}</span></div>`;
    s.requirements.forEach(req=>{
      const checked=!!docsState[s.id]?.[req.key];
      const row=document.createElement("label"); row.className="chk";
      row.innerHTML=`
        <input type="checkbox" ${checked?'checked':''} data-sid="${s.id}" data-key="${req.key}">
        <div style="flex:1">
          <div>${req.label}</div>
          <div class="sub">Due ${new Date(req.due).toLocaleDateString()}</div>
        </div>
        <button class="btn btn--quiet miniAI" type="button" data-school="${name}" data-doc="${req.label}">Help me write</button>
      `;
      block.appendChild(row);
    });
    panel.appendChild(block);
  });

  panel.addEventListener("change",(e)=>{
    if(e.target.matches('input[type="checkbox"]')){
      const sid=e.target.dataset.sid, key=e.target.dataset.key;
      const st=get(K.DOCS,{}); st[sid]=st[sid]||{}; st[sid][key]=e.target.checked; set(K.DOCS,st);
      renderTimeline();
    }
  });
  panel.addEventListener("click",(e)=>{
    const b=e.target.closest(".miniAI"); if(!b) return;
    const plan=get(K.PLAN,{});
    const msg=`I need help drafting "${b.dataset.doc}" for ${b.dataset.school}. My interests: ${plan.interests?.join(", ")||"—"}.`;
    showAIBubble(msg,true);
  });

  if(focusSchool){
    Array.from(panel.children).forEach(c=>{ if(!c.textContent.includes(focusSchool)) c.classList.add("hidden"); });
  }
}

/* =========================
   Aid
   ========================= */
function pellEstimate(efc){
  if(efc<=6000) return 7395;
  if(efc<=10000) return 3500;
  return 0;
}
function calGrantEligible(plan, school){
  return plan?.state==="CA" && school.public && (plan.gpa||0)>=3.0;
}
function renderAid(focusSchool){
  const panel=document.getElementById("aidPanel"); panel.innerHTML="";
  const picks=get(K.PICKS,[]); if(!picks.length){ panel.innerHTML=`<div class="sub">Add schools to see aid options.</div>`; return; }
  const plan=get(K.PLAN,{state:"CA"});
  const wrap=document.createElement("div"); panel.appendChild(wrap);

  const sel=document.createElement("select"); sel.className="select";
  picks.forEach(n=>{ const o=document.createElement("option"); o.value=n; o.textContent=n; sel.appendChild(o); });
  if(focusSchool) sel.value=focusSchool;
  wrap.appendChild(sel);

  const whatIf=document.createElement("div");
  whatIf.innerHTML=`
    <div class="grid-2" style="margin-top:12px">
      <div><div class="label">Family income (what-if)</div><input id="aidIncome" class="input" type="number" min="0" step="500" placeholder="e.g., 75000"></div>
      <div><div class="label">EFC/SAI (optional)</div><input id="aidEFC" class="input" type="number" min="0" step="100" placeholder="leave blank to estimate"></div>
    </div>
    <div class="row" style="margin-top:8px"><div class="sub">These are estimates; actual awards depend on FAFSA/CADAA + institution.</div><button id="recalcAid" class="btn btn--primary" type="button">Recalculate</button></div>
    <div id="aidOut" style="margin-top:12px"></div>
  `;
  wrap.appendChild(whatIf);

  function calcAndRender(){
    const school=SCHOOLS[sel.value];
    const efcIn=parseInt(document.getElementById("aidEFC").value)||8000;
    const resident=(school.private || school.state===plan.state);
    const tuition=resident ? school.tuitionResident : school.tuitionNonResident;

    const pell=pellEstimate(efcIn);
    const cal=calGrantEligible(plan,school)?12570:0; // rough
    const mcs=(plan.state==="CA" && !cal && school.public)?2500:0; // rough
    const total=pell+cal+mcs;
    const net=Math.max(0, tuition-total);

    document.getElementById("aidOut").innerHTML=`
      <div class="card">
        <div class="row"><strong>${sel.value}</strong><span class="tag">${resident?'Resident':'Non-resident'}</span></div>
        <div class="hr"></div>
        <div class="row"><div>Tuition</div><strong>$${tuition.toLocaleString()}</strong></div>
        <div class="row"><div>Estimated Pell Grant</div><strong>$${pell.toLocaleString()}</strong></div>
        <div class="row"><div>Cal Grant (if eligible)</div><strong>$${cal.toLocaleString()}</strong></div>
        <div class="row"><div>Middle Class Scholarship (rough)</div><strong>$${mcs.toLocaleString()}</strong></div>
        <div class="hr"></div>
        <div class="row"><div><strong>Estimated total grant aid</strong></div><strong>$${total.toLocaleString()}</strong></div>
        <div class="row"><div><strong>Estimated out-of-pocket</strong></div><strong>$${net.toLocaleString()}</strong></div>
      </div>`;
  }
  document.getElementById("recalcAid").onclick=calcAndRender;
  sel.onchange=calcAndRender;
  calcAndRender();
}

/* =========================
   AI helper (toast style)
   ========================= */
const toast = document.getElementById("toast");
function showAIBubble(text,autoHide=false){
  toast.textContent = text || "How can I help?";
  toast.classList.remove("hidden");
  if(autoHide){ setTimeout(()=>toast.classList.add("hidden"), 3500); }
}
document.getElementById("aiBtn").onclick=()=>{
  const active=document.querySelector('#seg .is-active')?.dataset.tab;
  const tips={plan:"Pick your interests to power matches + docs later.",
              schools:"Add 3–6 schools; we’ll auto-build your timeline.",
              docs:"Click “Help me write” for mini prompts.",
              aid:"Try the What-If section to compare quickly."};
  showAIBubble(tips[active]||"How can I help?", true);
};

/* =========================
   Initial boot
   ========================= */
window.addEventListener("DOMContentLoaded", ()=>{
  updateSummary();
  route(get(K.PLAN,null) ? "dash" : "plan");
});
</script>
</body>
</html>
