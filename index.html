<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CollegeQuest ‚Äî Your AI College Planning Assistant</title>

  <style>
    /* ========= THEME (unchanged, condensed) ========= */
    *{margin:0;padding:0;box-sizing:border-box;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    :root{
      --primary:linear-gradient(135deg,#667EEA 0%,#764BA2 100%);
      --secondary:linear-gradient(135deg,#F093FB 0%,#F5576C 100%);
      --success:linear-gradient(135deg,#00C896 0%,#00B4D8 100%);
      --warning:linear-gradient(135deg,#FFB700 0%,#FF6B6B 100%);
      --info:linear-gradient(135deg,#4FACFE 0%,#00F2FE 100%);
      --dark:#0F0F1E;--light:#fff;--glass:rgba(255,255,255,.10);--glass-dark:rgba(0,0,0,.3);
      --blur:20px;--text-primary:#fff;--text-secondary:rgba(255,255,255,.7);--border:rgba(255,255,255,.1);
      --glow-purple:#764BA2;--glow-blue:#667EEA;--ease-bounce:cubic-bezier(.68,-.55,.265,1.55);--ease-smooth:cubic-bezier(.4,0,.2,1)
    }
    [data-theme="light"]{--dark:#fff;--light:#0F0F1E;--glass:rgba(0,0,0,.05);--glass-dark:rgba(255,255,255,.8);--text-primary:#0F0F1E;--text-secondary:rgba(0,0,0,.6);--border:rgba(0,0,0,.1)}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--dark);color:var(--text-primary);overflow-x:hidden;min-height:100vh}
    .animated-bg{position:fixed;inset:0;z-index:-1;background:
      radial-gradient(circle at 20% 50%, rgba(102,126,234,.30) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(118,75,162,.30) 0%, transparent 50%),
      radial-gradient(circle at 40% 20%, rgba(240,147,251,.30) 0%, transparent 50%);
      animation:bgShift 20s ease infinite}
    @keyframes bgShift{0%,100%{transform:rotate(0) scale(1)}50%{transform:rotate(180deg) scale(1.1)}}
    .container{max-width:1400px;margin:0 auto;padding:20px;position:relative;z-index:1}
    header{display:flex;justify-content:space-between;align-items:center;padding:20px 0;margin-bottom:24px}
    .logo{font-size:28px;font-weight:800;background:var(--primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .nav-tabs{display:flex;gap:10px;padding:5px;background:var(--glass);border-radius:50px;backdrop-filter:blur(10px);margin-bottom:24px;overflow-x:auto;scrollbar-width:none}
    .nav-tabs::-webkit-scrollbar{display:none}
    .nav-tab{padding:12px 24px;border:none;background:transparent;color:var(--text-secondary);font-weight:600;border-radius:50px;cursor:pointer;transition:all .3s var(--ease-smooth);white-space:nowrap;font-size:14px}
    .nav-tab.active{background:var(--primary);color:#fff;box-shadow:0 4px 15px rgba(102,126,234,.3)}
    .nav-tab:hover:not(.active){background:var(--glass)}
    .card{background:var(--glass);backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));border-radius:20px;border:1px solid var(--border);padding:20px;transition:all .3s var(--ease-smooth);position:relative;overflow:hidden}
    .card:hover{transform:translateY(-3px);box-shadow:0 20px 40px rgba(102,126,234,.18);border-color:rgba(102,126,234,.5)}
    .btn{padding:12px 20px;border:none;border-radius:50px;font-weight:700;font-size:14px;cursor:pointer;transition:transform .2s var(--ease-bounce);display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{transform:translateY(-1px) scale(1.03)}
    .btn-glass{background:var(--glass);border:1px solid var(--border);color:var(--text-primary)}
    .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .form-label{display:block;margin-bottom:6px;font-weight:700;font-size:12px;letter-spacing:1px;color:var(--text-secondary);text-transform:uppercase}
    .form-input,.form-select{width:100%;padding:12px 14px;background:var(--glass);border:2px solid var(--border);border-radius:14px;color:var(--text-primary);font-size:15px}
    .form-input:focus,.form-select:focus{outline:none;border-color:var(--glow-purple);box-shadow:0 0 18px rgba(118,75,162,.18)}
    .schools-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
    .school-card{background:var(--glass);border-radius:18px;overflow:hidden;border:1px solid var(--border)}
    .school-image{width:100%;height:180px;object-fit:cover}
    .school-content{padding:14px}
    .toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(120px);background:var(--glass-dark);backdrop-filter:blur(18px);color:#fff;padding:12px 18px;border-radius:50px;border:1px solid rgba(255,255,255,.12);box-shadow:0 10px 30px rgba(0,0,0,.28);z-index:3000;opacity:0;transition:all .35s var(--ease-bounce)}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .kpi{background:var(--glass);border:1px solid var(--border);border-radius:16px;padding:18px;text-align:center}
    .kpi .n{font-size:32px;font-weight:800;background:var(--primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .ring{width:122px;height:122px;margin:0 auto 10px;position:relative}
    .muted{color:var(--text-secondary);font-size:13px}
    @media (max-width:768px){.nav-tab{padding:10px 16px;font-size:12px}}
  </style>
</head>

<body>
  <div class="animated-bg"></div>
  <div class="container">

    <!-- Header -->
    <header>
      <div class="logo">CollegeQuest</div>
      <div>
        <button class="btn btn-glass" onclick="toggleTheme()">üåô</button>
        <button class="btn btn-primary" onclick="showToast('Onboarding coming soon')">Get Started</button>
      </div>
    </header>

    <!-- Navigation -->
    <div class="nav-tabs" id="navTabs">
      <button class="nav-tab active" onclick="showTab('planning', this)">Planning</button>
      <button class="nav-tab" onclick="showTab('dashboard', this)">Dashboard</button>
      <button class="nav-tab" onclick="showTab('compare', this)">In vs Out of State</button>
      <button class="nav-tab" onclick="showTab('ai-assistant', this)">AI Assistant</button>
      <button class="nav-tab" onclick="showTab('schools', this)">Schools</button>
      <button class="nav-tab" onclick="showTab('applications', this)">Applications</button>
      <button class="nav-tab" onclick="showTab('scholarships', this)">Scholarships</button>
      <button class="nav-tab" onclick="showTab('community', this)">Community</button>
    </div>

    <main id="mainContent">

      <!-- =============== PLANNING (ENTRY) =============== -->
      <section id="planning-tab" class="tab-content">
        <div class="card" style="margin-bottom:16px">
          <h2 style="margin-bottom:8px">üìã College Planning Wizard</h2>
          <p class="muted" style="margin-bottom:12px">Start here. We‚Äôll compute reach/match/safety, scholarships, and wire up your dashboard.</p>

          <form id="planningForm">
            <div class="form-row">
              <div>
                <label class="form-label">Residency</label>
                <select id="residency" class="form-select">
                  <option value="in-state">In-State</option>
                  <option value="out-of-state">Out-of-State</option>
                </select>
              </div>
              <div>
                <label class="form-label">Home State (2 letters)</label>
                <input id="homeState" class="form-input" maxlength="2" placeholder="CA" />
              </div>
              <div>
                <label class="form-label">GPA (unweighted)</label>
                <input id="gpa" class="form-input" type="number" step="0.01" min="0" max="4" required />
              </div>
              <div>
                <label class="form-label">SAT</label>
                <input id="sat" class="form-input" type="number" min="400" max="1600" placeholder="Optional" />
              </div>
              <div>
                <label class="form-label">Budget / year (USD)</label>
                <input id="budget" class="form-input" type="number" placeholder="40000" />
              </div>
              <div>
                <label class="form-label">Intended Major</label>
                <input id="major" class="form-input" placeholder="Computer Science" />
              </div>
            </div>

            <!-- Gen-Alpha prefs -->
            <div class="form-row" style="margin-top:10px">
              <div><label class="form-label">Campus Vibe</label>
                <select id="vibe" class="form-select"><option>Collaborative</option><option>Competitive</option><option>Project-based</option><option>Research-focused</option></select>
              </div>
              <div><label class="form-label">Setting</label>
                <select id="setting" class="form-select"><option>Urban</option><option>Suburban</option><option>Rural</option></select>
              </div>
              <div><label class="form-label">Size</label>
                <select id="size" class="form-select"><option>Small (&lt;5k)</option><option>Medium (5k‚Äì15k)</option><option>Large (&gt;15k)</option></select>
              </div>
              <div><label class="form-label">Internships</label>
                <select id="intern" class="form-select"><option>Essential</option><option>Nice-to-have</option></select>
              </div>
              <div><label class="form-label">Study Abroad</label>
                <select id="abroad" class="form-select"><option>Must have</option><option>Nice-to-have</option></select>
              </div>
              <div><label class="form-label">DEI Priority</label>
                <select id="dei" class="form-select"><option>High</option><option>Medium</option><option>Low</option></select>
              </div>
            </div>

            <div style="display:flex;gap:10px;margin-top:12px">
              <button class="btn btn-primary" type="submit">üöÄ Get Recommendations</button>
              <button class="btn btn-glass" type="button" onclick="resetPlanning()">Reset</button>
            </div>
          </form>
        </div>

        <div class="card" id="recommendations" style="display:none">
          <h3 style="margin-bottom:10px">üéØ School Recommendations</h3>
          <div id="schoolBuckets"></div>

          <h3 style="margin:16px 0 8px">üí∞ Scholarship Matches</h3>
          <div id="scholarshipList"></div>
        </div>
      </section>

      <!-- =============== DASHBOARD =============== -->
      <section id="dashboard-tab" class="tab-content" style="display:none">
        <div class="kpi-grid" style="margin-bottom:16px">
          <div class="kpi"><div>üéØ</div><div class="n" id="kpiMatched">0</div><div class="muted">Matched Schools</div></div>
          <div class="kpi"><div>üí∞</div><div class="n" id="kpiSavings">$0</div><div class="muted">Potential Savings</div></div>
          <div class="kpi"><div>üéì</div><div class="n" id="kpiScholarships">0</div><div class="muted">Scholarships Matched</div></div>
          <div class="kpi"><div>üìà</div><div class="n" id="kpiTopRoi">‚Äî</div><div class="muted">Top Choice ROI (10y)</div></div>
          <div class="kpi"><div>üßæ</div><div class="n" id="kpiAvgCost">‚Äî</div><div class="muted">Avg 4-Year Cost (plan)</div></div>
          <div class="kpi"><div>üìù</div><div class="n" id="kpiApps">0/0</div><div class="muted">Apps Submitted</div></div>
        </div>

        <div class="kpi-grid">
          <div class="kpi">
            <div class="ring">
              <svg width="122" height="122"><circle cx="61" cy="61" r="50" stroke="var(--border)" stroke-width="8" fill="none"></circle><circle id="ringApps" cx="61" cy="61" r="50" stroke="url(#grad1)" stroke-width="8" stroke-linecap="round" fill="none" stroke-dasharray="314" stroke-dashoffset="314"></circle></svg>
              <div id="valApps" style="position:absolute;left:0;right:0;top:46px;text-align:center;font-weight:800">0%</div>
            </div>
            <div class="muted">Application Progress</div>
          </div>

          <div class="kpi">
            <div class="ring">
              <svg width="122" height="122"><circle cx="61" cy="61" r="50" stroke="var(--border)" stroke-width="8" fill="none"></circle><circle id="ringProfile" cx="61" cy="61" r="50" stroke="url(#grad1)" stroke-width="8" stroke-linecap="round" fill="none" stroke-dasharray="314" stroke-dashoffset="314"></circle></svg>
              <div id="valProfile" style="position:absolute;left:0;right:0;top:46px;text-align:center;font-weight:800">0%</div>
            </div>
            <div class="muted">Profile Complete</div>
          </div>

          <div class="kpi">
            <div class="ring">
              <svg width="122" height="122"><circle cx="61" cy="61" r="50" stroke="var(--border)" stroke-width="8" fill="none"></circle><circle id="ringEssays" cx="61" cy="61" r="50" stroke="url(#grad1)" stroke-width="8" stroke-linecap="round" fill="none" stroke-dasharray="314" stroke-dashoffset="314"></circle></svg>
              <div id="valEssays" style="position:absolute;left:0;right:0;top:46px;text-align:center;font-weight:800">0%</div>
            </div>
            <div class="muted">Essays Written</div>
          </div>
        </div>

        <!-- gradient def once on page -->
        <svg width="0" height="0" style="position:absolute">
          <defs><linearGradient id="grad1" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#667EEA"/><stop offset="100%" stop-color="#764BA2"/></linearGradient></defs>
        </svg>
      </section>

      <!-- =============== COMPARE =============== -->
      <section id="compare-tab" class="tab-content" style="display:none">
        <h2 style="margin-bottom:12px">In-State vs Out-of-State Analysis</h2>
        <div class="form-row" style="margin:8px 0 16px">
          <div class="card">
            <h3>üè† In-State Aggregate</h3>
            <div id="aggIn"></div>
          </div>
          <div class="card">
            <h3>‚úàÔ∏è Out-of-State Aggregate</h3>
            <div id="aggOut"></div>
          </div>
        </div>
        <div class="card">
          <h3 style="margin-bottom:8px">üí° AI Insight</h3>
          <p id="compareText" class="muted">Run the planner to see insights here.</p>
        </div>
      </section>

      <!-- =============== AI ASSISTANT =============== -->
      <section id="ai-assistant-tab" class="tab-content" style="display:none">
        <div class="card" style="padding:0;overflow:hidden">
          <div style="background:var(--primary);color:#fff;padding:16px;font-weight:700">AI College Assistant</div>
          <div id="chatMessages" style="height:420px;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:10px">
            <div class="card" style="border:none;background:var(--glass);padding:12px">Hi! Ask me about schools, essays, scholarships, or strategy. I‚Äôll use your plan if available.</div>
          </div>
          <div style="display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)">
            <input id="chatInput" class="form-input" placeholder="Ask me anything‚Ä¶" onkeypress="handleChatEnter(event)">
            <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
          </div>
        </div>
      </section>

      <!-- =============== SCHOOLS =============== -->
      <section id="schools-tab" class="tab-content" style="display:none">
        <h2 style="margin-bottom:10px">Schools</h2>
        <div id="schoolsGrid" class="schools-grid"></div>
      </section>

      <!-- =============== APPLICATIONS =============== -->
      <section id="applications-tab" class="tab-content" style="display:none">
        <h2 style="margin-bottom:10px">Applications</h2>
        <div id="appsList"></div>
      </section>

      <!-- =============== SCHOLARSHIPS =============== -->
      <section id="scholarships-tab" class="tab-content" style="display:none">
        <h2 style="margin-bottom:10px">Scholarships</h2>
        <div id="scholarshipsAll"></div>
      </section>

      <!-- =============== COMMUNITY =============== -->
      <section id="community-tab" class="tab-content" style="display:none">
        <div class="card">
          <h2 style="margin-bottom:10px">Community</h2>
          <div class="muted">Sample feed. You can wire a real backend later.</div>
          <div style="margin-top:10px">
            <div class="card" style="margin-bottom:8px"><b>Jessica Davis</b> ‚Äî Just got accepted to UCLA! üéâ</div>
            <div class="card"><b>Mike Rodriguez</b> ‚Äî Pro tip: Start your essays early; my 15th draft finally hit.</div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script>
  /* ===========================
     CONFIG + BACKEND DETECTION
     =========================== */
  const API_CONFIG = { baseUrl: "http://localhost:3000/api", USE_BACKEND: true };
  async function detectBackend(){
    try{
      const res = await fetch(API_CONFIG.baseUrl + "/scholarships", {
        method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ping:true})
      });
      if(!res.ok) throw 0;
      showToast("Backend detected ‚úîÔ∏é");
      API_CONFIG.USE_BACKEND = true;
    }catch{
      API_CONFIG.USE_BACKEND = false;
      showToast("Backend not found ‚Äî using local engine.");
    }
  }
  detectBackend();

  /* ======================
     STATE + SAMPLE DATASET
     ====================== */
  const AppState = {
    currentTab: "planning",
    profile: null,
    matches: { reach:[], match:[], safety:[] },
    scholarships: [],
    applications: []
  };

  // Expanded dataset (12) to avoid short lists
  const SchoolDB = [
    {id:1,name:"Stanford University",state:"CA",ranking:3,acceptRate:0.04,tuitionIn:56000,tuitionOut:56000,fees:2000,roomBoard:18000,gradSalary:110000,setting:"Suburban",size:"Medium (5k‚Äì15k)",vibe:"Competitive",majors:["Computer Science","Business","Physics"],testOptional:true,deadlines:{ea:"2025-11-01",rd:"2026-01-03"}},
    {id:2,name:"MIT",state:"MA",ranking:1,acceptRate:0.07,tuitionIn:58000,tuitionOut:58000,fees:2200,roomBoard:19000,gradSalary:115000,setting:"Urban",size:"Small (<5k)",vibe:"Research-focused",majors:["Computer Science","EE","Math"],testOptional:false,deadlines:{ea:"2025-11-01",rd:"2026-01-05"}},
    {id:3,name:"UC Berkeley",state:"CA",ranking:22,acceptRate:0.14,tuitionIn:15000,tuitionOut:44000,fees:2500,roomBoard:19000,gradSalary:98000,setting:"Urban",size:"Large (>15k)",vibe:"Competitive",majors:["CS","EECS","Economics"],testOptional:true,deadlines:{rd:"2025-11-30"}},
    {id:4,name:"UCLA",state:"CA",ranking:20,acceptRate:0.10,tuitionIn:15000,tuitionOut:44000,fees:2500,roomBoard:19000,gradSalary:93000,setting:"Urban",size:"Large (>15k)",vibe:"Collaborative",majors:["Biology","CS","Film"],testOptional:true,deadlines:{rd:"2025-11-30"}},
    {id:5,name:"UC Davis",state:"CA",ranking:38,acceptRate:0.48,tuitionIn:15000,tuitionOut:34000,fees:2500,roomBoard:17000,gradSalary:82000,setting:"Suburban",size:"Large (>15k)",vibe:"Collaborative",majors:["Biology","CS","Economics"],testOptional:true,deadlines:{rd:"2025-11-30"}},
    {id:6,name:"University of Washington",state:"WA",ranking:40,acceptRate:0.47,tuitionIn:13000,tuitionOut:37000,fees:2400,roomBoard:17500,gradSalary:85000,setting:"Urban",size:"Large (>15k)",vibe:"Project-based",majors:["CS","Information","Design"],testOptional:true,deadlines:{rd:"2025-12-01"}},
    {id:7,name:"Georgia Tech",state:"GA",ranking:33,acceptRate:0.17,tuitionIn:12000,tuitionOut:34000,fees:2200,roomBoard:16000,gradSalary:95000,setting:"Urban",size:"Large (>15k)",vibe:"Research-focused",majors:["CS","AE","ME"],testOptional:true,deadlines:{ea:"2025-10-18",rd:"2026-01-04"}},
    {id:8,name:"UT Austin",state:"TX",ranking:32,acceptRate:0.29,tuitionIn:11000,tuitionOut:40000,fees:1800,roomBoard:15000,gradSalary:88000,setting:"Urban",size:"Large (>15k)",vibe:"Collaborative",majors:["CS","Business","Design"],testOptional:true,deadlines:{ea:"2025-11-01",rd:"2025-12-01"}},
    {id:9,name:"Purdue University",state:"IN",ranking:47,acceptRate:0.53,tuitionIn:10000,tuitionOut:29000,fees:1700,roomBoard:14000,gradSalary:82000,setting:"Suburban",size:"Large (>15k)",vibe:"Project-based",majors:["CS","ME","EE"],testOptional:true,deadlines:{rd:"2025-11-01"}},
    {id:10,name:"Northeastern University",state:"MA",ranking:53,acceptRate:0.18,tuitionIn:62000,tuitionOut:62000,fees:2100,roomBoard:19000,gradSalary:87000,setting:"Urban",size:"Large (>15k)",vibe:"Co-op",majors:["CS","Business","Data"],testOptional:true,deadlines:{ea:"2025-11-01",rd:"2026-01-01"}},
    {id:11,name:"San Jose State University",state:"CA",ranking:150,acceptRate:0.80,tuitionIn:9000,tuitionOut:19000,fees:1800,roomBoard:16000,gradSalary:78000,setting:"Urban",size:"Large (>15k)",vibe:"Collaborative",majors:["CS","Business","Design"],testOptional:true,deadlines:{rd:"2025-12-15"}},
    {id:12,name:"Cal State Fullerton",state:"CA",ranking:160,acceptRate:0.75,tuitionIn:8500,tuitionOut:18000,fees:1700,roomBoard:15000,gradSalary:72000,setting:"Suburban",size:"Large (>15k)",vibe:"Collaborative",majors:["Business","Psychology","CS"],testOptional:true,deadlines:{rd:"2025-12-10"}}
  ];

  const ScholarshipDB = [
    {id:"sch-tt", name:"Tech Trailblazers", amount:7500, criteria:"STEM majors, GPA ‚â• 3.5", due:"2025-11-01", tags:["STEM","Merit"]},
    {id:"sch-fg", name:"First Gen Leaders", amount:5000, criteria:"First-gen students", due:"2025-12-01", tags:["DEI","Need"]},
    {id:"sch-wb", name:"Women in Business", amount:6000, criteria:"Business majors, women", due:"2025-10-20", tags:["Business","Women"]},
    {id:"sch-cs", name:"Code for Good", amount:4000, criteria:"CS majors, community impact", due:"2025-11-15", tags:["CS","Service"]},
    {id:"sch-ho", name:"Horizon Opportunity", amount:3500, criteria:"Any major, GPA ‚â• 3.2", due:"2025-12-10", tags:["Merit"]},
    {id:"sch-dei", name:"Inclusive Excellence", amount:5500, criteria:"DEI leadership", due:"2025-11-30", tags:["DEI"]}
  ];

  /* ======================
     UTILS / SCORING
     ====================== */
  const n = (x, d=0) => Number.isFinite(x) ? x.toFixed(d) : "‚Äî";
  function computeCost4Y(s, residency, travel = residency==='in-state'?500:2500){
    const tuition = residency==='in-state' ? (s.tuitionIn ?? s.tuitionOut ?? 0) : (s.tuitionOut ?? s.tuitionIn ?? 0);
    const fees = s.fees ?? 0, rb = s.roomBoard ?? 0;
    const yearly = tuition + fees + rb + travel;
    return Math.max(0, yearly * 4);
  }
  function roiScore(s, residency){
    const cost = computeCost4Y(s, residency);
    const salary10y = (s.gradSalary ?? 0) * 10;
    if (!cost) return 0;
    return (salary10y - cost) / cost; // ratio
  }
  function difficultyScore(s){
    const r = 201 - Math.min(s.ranking ?? 200, 200);
    const acc = (s.acceptRate ?? 0.5);
    return (1 - acc) * 100 + r;
  }
  function studentStrength({gpa, sat}){
    const G = Math.min(4, Math.max(0, +gpa || 0));   // 0..4
    const S = sat ? Math.min(1600, Math.max(400, +sat)) : 1000; // assume mid if empty
    return (G/4)*60 + ((S-400)/1200)*40; // 0..100
  }

  function bucketizeSchools(profile){
    const strength = studentStrength(profile);
    const filtered = SchoolDB.filter(s => {
      if (profile.major) {
        const ok = (s.majors||[]).some(m => m.toLowerCase().includes(profile.major.toLowerCase()));
        if (!ok) return false;
      }
      return true;
    });

    // preference + ROI sort
    const ranked = filtered.sort((a,b)=>{
      let af=0,bf=0;
      if (profile.setting){ if (a.setting===profile.setting) af+=5; if (b.setting===profile.setting) bf+=5; }
      if (profile.size){ if (a.size===profile.size) af+=3; if (b.size===profile.size) bf+=3; }
      if (profile.vibe){ if (a.vibe===profile.vibe) af+=2; if (b.vibe===profile.vibe) bf+=2; }
      af += roiScore(a, profile.residency) * 10;
      bf += roiScore(b, profile.residency) * 10;
      return bf-af;
    });

    const reach=[], match=[], safety=[];
    for (const s of ranked){
      const d = difficultyScore(s);
      if (d > strength + 25) reach.push(s);
      else if (d > strength - 10) match.push(s);
      else safety.push(s);
    }
    // don‚Äôt hard-slice; show everything we have
    return { reach, match, safety };
  }

  function matchScholarships(profile){
    return ScholarshipDB.filter(sch => {
      if (sch.criteria.includes("GPA ‚â• 3.5") && (profile.gpa ?? 0) < 3.5) return false;
      if (/CS|computer/i.test(sch.criteria) && !(profile.major||"").match(/CS|computer/i)) return false;
      if (profile.dei === "High" && (sch.tags||[]).includes("DEI")) return true;
      return true;
    });
  }

  /* ======================
     APPLICATIONS TRACKER
     ====================== */
  class AppTracker {
    constructor(){ this.apps=[]; }
    addSchool(s){
      if (this.apps.find(a=>a.schoolId===s.id)) return;
      const tasks=[
        {name:"Complete Common App",required:true,status:"pending"},
        {name:"Submit transcripts",required:true,status:"pending"},
        {name:"Request recommendations",required:true,status:"pending"},
        {name:"Write supplemental essays",required:true,status:"pending"},
        {name:"Submit test scores",required:!s.testOptional,status:"pending"},
        {name:"Complete CSS Profile",required:(s.ranking||999)<60,status:"pending"},
        {name:"Pay application fee",required:true,status:"pending"}
      ];
      const deadline = s.deadlines?.ea || s.deadlines?.rd || "2025-12-15";
      this.apps.push({id:Date.now()+Math.random(),schoolId:s.id,name:s.name,deadline,tasks,submitted:false});
      renderApplications(); renderDashboard();
    }
    progress(a){ const req=a.tasks.filter(t=>t.required).length||1; const done=a.tasks.filter(t=>t.required&&t.status==='completed').length; return Math.round(100*done/req); }
    nextDeadlineDays(){
      const future = this.apps.map(a=>({days: Math.ceil((new Date(a.deadline)-new Date())/86400000)})).filter(d=>d.days>0).sort((a,b)=>a.days-b.days)[0];
      return future?.days ?? "‚Äî";
    }
  }
  const Apps = new AppTracker();

  /* ======================
     RENDER HELPERS
     ====================== */
  function showTab(name, btn){
    document.querySelectorAll('.tab-content').forEach(el=>el.style.display='none');
    document.getElementById(`${name}-tab`).style.display='block';
    document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    AppState.currentTab = name;

    // ensure dependent tabs update
    if (name==='schools') renderSchoolsGrid();
    if (name==='scholarships') renderScholarshipsTab();
    if (name==='dashboard') renderDashboard();
    if (name==='compare') renderCompareAggregate();
  }
  function toggleTheme(){
    const cur=document.body.getAttribute('data-theme');
    const next= cur==='light'?'dark':'light';
    document.body.setAttribute('data-theme',next);
    localStorage.setItem('theme',next);
  }
  function showToast(msg){
    const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
    setTimeout(()=>{t.classList.add('show'); setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),250)},2300)},80);
  }
  const money = (x)=> `$${Number.isFinite(+x)? (+x).toLocaleString() : '‚Äî'}`;

  /* ======================
     RENDERS: Planning ‚Üí Recos
     ====================== */
  function renderMatches(){
    const cont = document.getElementById('schoolBuckets');
    const section = (title, arr) => `
      <div class="card" style="margin-bottom:10px">
        <h4 style="margin-bottom:8px">${title}</h4>
        ${arr.length?arr.map(s=>`
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)">
            <div>
              <div style="font-weight:800">${s.name}</div>
              <div class="muted">Accept: ${n((s.acceptRate??0)*100,0)}% ‚Ä¢ Est. 4y Cost: ${money(computeCost4Y(s, AppState.profile?.residency||'in-state'))}</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-glass" onclick="addApplication(${s.id})">Add</button>
              <button class="btn btn-primary" onclick="openCompare(${s.id})">Compare</button>
            </div>
          </div>`).join('') : `<div class="muted">No schools in this bucket.</div>`}
      </div>`;
    cont.innerHTML = section("Reach", AppState.matches.reach) + section("Match", AppState.matches.match) + section("Safety", AppState.matches.safety);

    renderSchoolsGrid(); // keep Schools tab in sync
  }

  function renderScholarshipsList(){
    const list = document.getElementById('scholarshipList');
    list.innerHTML = AppState.scholarships.map(s=>`
      <div class="card" style="margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
        <div><b>${s.name}</b><div class="muted">${s.criteria} ‚Ä¢ Due ${s.due}</div></div>
        <div class="btn btn-success" style="cursor:default">${money(s.amount)}</div>
      </div>`).join('') || `<div class="muted">No scholarships matched (try raising GPA or changing major).</div>`;
    renderScholarshipsTab(); // keep tab in sync
  }

  function renderSchoolsGrid(){
    const grid = document.getElementById('schoolsGrid');
    const all = [...AppState.matches.reach, ...AppState.matches.match, ...AppState.matches.safety];
    grid.innerHTML = all.map(s=>`
      <div class="school-card">
        <img class="school-image" alt="${s.name}" src="https://picsum.photos/seed/${encodeURIComponent(s.name)}/600/400">
        <div class="school-content">
          <div style="font-weight:800">${s.name}</div>
          <div class="muted">${s.state} ‚Ä¢ Rank #${s.ranking ?? '‚Äî'}</div>
          <div class="muted" style="margin-top:4px">Tuition: ${money((AppState.profile?.residency==='in-state') ? (s.tuitionIn ?? s.tuitionOut) : (s.tuitionOut ?? s.tuitionIn))}</div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn btn-glass" onclick="addApplication(${s.id})">Add to Applications</button>
            <button class="btn btn-primary" onclick="openCompare(${s.id})">Compare</button>
          </div>
        </div>
      </div>`).join('') || `<div class="card">No schools yet ‚Äî run the planner first.</div>`;
  }

  function renderScholarshipsTab(){
    const el = document.getElementById('scholarshipsAll');
    el.innerHTML = document.getElementById('scholarshipList')?.innerHTML || `<div class="card">No scholarships yet ‚Äî run the planner first.</div>`;
  }

  /* ======================
     RENDERS: Dashboard
     ====================== */
  function renderDashboard(){
    const all = [...AppState.matches.reach, ...AppState.matches.match, ...AppState.matches.safety];
    document.getElementById('kpiMatched').textContent = all.length;

    // savings: diff between average cost and min cost
    if (all.length){
      const costs = all.map(s=>computeCost4Y(s, AppState.profile?.residency||'in-state'));
      const avg = costs.reduce((a,b)=>a+b,0)/costs.length;
      const min = Math.min(...costs);
      document.getElementById('kpiSavings').textContent = money(Math.max(0, Math.round(avg-min)));
      document.getElementById('kpiAvgCost').textContent = money(Math.round(avg));
      // top ROI from matches
      const top = all.slice().sort((a,b)=>roiScore(b,AppState.profile?.residency)-roiScore(a,AppState.profile?.residency))[0];
      const topR = roiScore(top, AppState.profile?.residency);
      document.getElementById('kpiTopRoi').textContent = Number.isFinite(topR) ? (topR*100).toFixed(0)+"%" : "‚Äî";
    } else {
      document.getElementById('kpiSavings').textContent = "$0";
      document.getElementById('kpiAvgCost').textContent = "‚Äî";
      document.getElementById('kpiTopRoi').textContent = "‚Äî";
    }

    document.getElementById('kpiScholarships').textContent = AppState.scholarships.length;
    const total = Apps.apps.length;
    const submitted = Apps.apps.filter(a=>a.submitted).length;
    document.getElementById('kpiApps').textContent = `${submitted}/${total}`;

    const appsPct = total? Math.round(100*submitted/total):0;
    setRing('ringApps','valApps',appsPct);
    setRing('ringProfile','valProfile', AppState.profile? 70:20);
    const essaysPct = Math.min(100, Apps.apps.reduce((acc,a)=> acc + (a.tasks.some(t=>/essay/i.test(t.name)&&t.status==='completed')?1:0),0)*20);
    setRing('ringEssays','valEssays', essaysPct);
  }
  function setRing(circleId, labelId, pct){
    const c=document.getElementById(circleId); const L=document.getElementById(labelId);
    const C=314, off=Math.round(C*(1-pct/100)); c?.setAttribute('stroke-dashoffset',off); if(L) L.textContent = `${pct}%`;
  }

  /* ======================
     RENDERS: Compare Aggregate
     ====================== */
  function renderCompareAggregate(){
    const inList = SchoolDB.filter(s => (AppState.profile?.residency||'in-state')==='in-state' ? true : true); // lists derive from matches
    const all = [...AppState.matches.reach, ...AppState.matches.match, ...AppState.matches.safety];
    if (!all.length){ document.getElementById('aggIn').innerHTML = `<div class="muted">Run planner to populate.</div>`; document.getElementById('aggOut').innerHTML = `<div class="muted">Run planner to populate.</div>`; return; }

    const inAgg = all.map(s=>({c:computeCost4Y(s,'in-state'),roi:roiScore(s,'in-state')}));
    const outAgg= all.map(s=>({c:computeCost4Y(s,'out-of-state'),roi:roiScore(s,'out-of-state')}));
    const avg = arr => Math.round(arr.reduce((a,b)=>a+b,0)/arr.length);
    const avgR = arr => (arr.reduce((a,b)=>a+b,0)/arr.length);

    document.getElementById('aggIn').innerHTML = `
      <div class="muted">Avg 4-Year Cost</div><div style="font-weight:800">${money(avg(inAgg.map(x=>x.c)))}</div>
      <div class="muted" style="margin-top:6px">Avg ROI (10y)</div><div style="font-weight:800">${(avgR(inAgg.map(x=>x.roi))*100).toFixed(0)}%</div>`;
    document.getElementById('aggOut').innerHTML = `
      <div class="muted">Avg 4-Year Cost</div><div style="font-weight:800">${money(avg(outAgg.map(x=>x.c)))}</div>
      <div class="muted" style="margin-top:6px">Avg ROI (10y)</div><div style="font-weight:800">${(avgR(outAgg.map(x=>x.roi))*100).toFixed(0)}%</div>`;

    // AI (or local) insight
    setCompareInsight(all[0]);
  }

  async function setCompareInsight(sample){
    const el=document.getElementById('compareText');
    const p = AppState.profile || {};
    const prompt = `Student residency=${p.residency}, GPA=${p.gpa}, SAT=${p.sat||'n/a'}, budget=${p.budget||'n/a'}; compare average in-state vs out-of-state across matched schools. Weigh ROI, 4-year cost, likely merit. Give 2 sentences and a recommendation.`;
    if (API_CONFIG.USE_BACKEND){
      try{
        const r = await fetch(API_CONFIG.baseUrl+"/ai/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:prompt})});
        const j = await r.json(); el.textContent = j.response || "Insight unavailable.";
        return;
      }catch{/* fallthrough */}
    }
    el.textContent = `Locally computed: In-state paths usually win on cost; out-of-state can overtake when merit + outcomes (ranked programs) offset the premium. Pick 2‚Äì3 out-of-state targets with strong merit leverage and keep at least 3 in-state options to protect ROI.`;
  }

  /* ======================
     ACTIONS
     ====================== */
  function addApplication(id){
    const s = SchoolDB.find(x=>x.id===id) || [...AppState.matches.reach, ...AppState.matches.match, ...AppState.matches.safety].find(x=>x.id===id);
    if (!s) return;
    Apps.addSchool(s); showToast(`Added ${s.name} to Applications`);
  }
  function toggleTask(appId, idx, checked){
    const app = Apps.apps.find(a=>String(a.id)===String(appId)); if(!app) return;
    app.tasks[idx].status = checked ? 'completed' : 'pending';
    renderApplications(); renderDashboard();
  }
  function markSubmitted(appId){
    const app = Apps.apps.find(a=>String(a.id)===String(appId)); if(!app) return;
    app.submitted = true; renderApplications(); renderDashboard(); showToast(`Marked submitted: ${app.name}`);
  }
  function openCompare(id){
    const btn = document.querySelector('#navTabs button:nth-child(3)');
    showTab('compare', btn); renderCompareAggregate();
  }

  /* ======================
     RENDER: Applications
     ====================== */
  function renderApplications(){
    const el=document.getElementById('appsList');
    if (!Apps.apps.length){ el.innerHTML=`<div class="card">No applications yet ‚Äî add from Planning or Schools.</div>`; return; }
    el.innerHTML = Apps.apps.map(a=>{
      const p = Apps.progress(a);
      return `<div class="card" style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div><b>${a.name}</b><div class="muted">Deadline: ${a.deadline}</div></div>
          <div style="font-weight:800">${p}%</div>
        </div>
        <div>${a.tasks.map((t,i)=>`
          <label style="display:flex;align-items:center;gap:8px;margin:6px 0">
            <input type="checkbox" ${t.status==='completed'?'checked':''} onchange="toggleTask('${a.id}', ${i}, this.checked)">
            <span>${t.name}${t.required?' *':''}</span>
          </label>`).join('')}
        </div>
        <div style="margin-top:6px"><button class="btn btn-primary" onclick="markSubmitted('${a.id}')">Mark Submitted</button></div>
      </div>`;
    }).join('');
  }

  /* ======================
     PLANNING SUBMIT (Backend + Fallback)
     ====================== */
  document.getElementById('planningForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const profile = {
      residency: document.getElementById('residency').value,
      state: (document.getElementById('homeState').value||'').toUpperCase(),
      gpa: parseFloat(document.getElementById('gpa').value),
      sat: parseInt(document.getElementById('sat').value)||null,
      budget: parseInt(document.getElementById('budget').value)||null,
      major: (document.getElementById('major').value||'').trim(),
      vibe: document.getElementById('vibe').value,
      setting: document.getElementById('setting').value,
      size: document.getElementById('size').value,
      intern: document.getElementById('intern').value,
      abroad: document.getElementById('abroad').value,
      dei: document.getElementById('dei').value
    };
    AppState.profile = profile;

    // MATCHES + SCHOLARSHIPS
    if (API_CONFIG.USE_BACKEND){
      try{
        const m = await fetch(API_CONFIG.baseUrl+"/match",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(profile)});
        const mj = await m.json(); if (mj?.recos) AppState.matches = mj.recos; else throw 0;
      }catch{ AppState.matches = bucketizeSchools(profile); }
      try{
        const s = await fetch(API_CONFIG.baseUrl+"/scholarships",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(profile)});
        const sj = await s.json(); if (sj?.scholarships) AppState.scholarships = sj.scholarships; else throw 0;
      }catch{ AppState.scholarships = matchScholarships(profile); }
    } else {
      AppState.matches = bucketizeSchools(profile);
      AppState.scholarships = matchScholarships(profile);
    }

    document.getElementById('recommendations').style.display='block';
    renderMatches();
    renderScholarshipsList();
    renderDashboard();
    renderCompareAggregate();
    showToast("Plan generated ‚úÖ");
  });

  /* ======================
     AI CHAT (backend/fallback)
     ====================== */
  async function sendChatMessage(){
    const input=document.getElementById('chatInput'); const msg=(input.value||'').trim(); if(!msg) return;
    const box=document.getElementById('chatMessages'); input.value='';
    box.insertAdjacentHTML('beforeend', `<div class="card" style="border:none;background:var(--glass);padding:12px;align-self:flex-end">${msg}</div>`);
    try{
      if (API_CONFIG.USE_BACKEND){
        const r=await fetch(API_CONFIG.baseUrl+"/ai/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:msg,context:{profile:AppState.profile,matches:AppState.matches}})});
        const j=await r.json(); box.insertAdjacentHTML('beforeend', `<div class="card" style="border:none;background:var(--glass);padding:12px">${j.response||'No response.'}</div>`);
      } else {
        const top=[...AppState.matches.match,...AppState.matches.reach,...AppState.matches.safety][0];
        const fb = top? `Based on your plan, ${top.name} looks promising for your major. Want a task checklist to start the app?` : `Tell me your GPA, SAT and major to get started.`;
        box.insertAdjacentHTML('beforeend', `<div class="card" style="border:none;background:var(--glass);padding:12px">${fb}</div>`);
      }
    }catch{
      box.insertAdjacentHTML('beforeend', `<div class="card" style="border:none;background:var(--glass);padding:12px">Assistant is offline. Try again later.</div>`);
    }
    box.scrollTop = box.scrollHeight;
  }
  function handleChatEnter(e){ if (e.key==='Enter') sendChatMessage(); }

  /* ======================
     INIT
     ====================== */
  (function init(){
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.body.setAttribute('data-theme', savedTheme);
  })();

  function resetPlanning(){
    document.getElementById('planningForm').reset();
    document.getElementById('recommendations').style.display='none';
  }
  </script>
</body>
</html>
