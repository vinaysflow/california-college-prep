<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Pathwise ‚Äî California College Planner</title>
<style>
  :root{
    --bg:#0b0f16; --card:#0f1420; --muted:#aab3c2; --text:#eaf0ff;
    --primary:#4c8dff; --primary-2:#7a6cff; --ok:#19c37d; --warn:#ffb020; --danger:#ff5a5f;
    --ring: rgba(76,141,255,.55);
    --bord: #1c2434; --chip: #121a2a;
    --pill:#0e1727; --pill-b:#263249;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
    background:radial-gradient(1200px 800px at 60% -10%, rgba(80,95,255,.18), transparent 45%), var(--bg);
    color:var(--text);
  }
  a{color:var(--primary); text-decoration:none} a:hover{text-decoration:underline}
  .app{max-width:1180px;margin:0 auto;padding:20px 16px 120px}
  /* header */
  .nav{
    position:sticky;top:0;z-index:30;backdrop-filter:saturate(1.2) blur(14px);
    background:linear-gradient(180deg, rgba(11,15,22,.85), rgba(11,15,22,.65) 60%, transparent);
    border-bottom:1px solid var(--bord); padding:10px 16px; margin:0 -16px 14px;
  }
  .nav .row{display:flex;align-items:center;gap:10px}
  .brand{font-weight:800;letter-spacing:.2px;font-size:22px;margin-right:8px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{
    background:var(--pill); color:#e9f2ff; border:1px solid var(--pill-b);
    padding:10px 14px;border-radius:999px; cursor:pointer; font-weight:700;
  }
  .tab.active{background:linear-gradient(90deg,var(--primary),var(--primary-2)); border-color:transparent;}
  .grow{flex:1}
  .btn{
    background:#121a2a;border:1px solid #293449;color:#eaf0ff;border-radius:10px;padding:10px 12px;cursor:pointer;
  }
  .btn.primary{background:linear-gradient(90deg,var(--primary),var(--primary-2)); border-color:transparent; color:#fff}
  .btn:hover{filter:brightness(1.04)}
  .btn:active{transform:translateY(1px)}
  .pill{background:#0f182b;border:1px solid #2b3a55;color:#cfe1ff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .pill.sel{background:linear-gradient(90deg,var(--primary),var(--primary-2));border-color:transparent;color:#fff}
  /* cards */
  .h1{font-size:28px;font-weight:800;margin:18px 0 8px}
  .muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
  .card{background:var(--card);border:1px solid var(--bord);border-radius:16px;padding:16px}
  .k{grid-column:span 4}
  .k2{grid-column:span 6}
  .k3{grid-column:span 12}
  @media (max-width:900px){.k{grid-column:span 12}.k2{grid-column:span 12}}
  .stat .name{color:#9fb0c8;font-weight:700}
  .stat .val{font-size:34px;font-weight:900;opacity:.94;margin-top:8px}
  .row{display:flex;gap:10px;align-items:center}
  .right{margin-left:auto}
  .tag{background:#102037;border:1px solid #283a5d;border-radius:999px;padding:4px 10px;font-size:12px}
  .tag.ok{border-color:#1a5f46;background:rgba(25,195,125,.1);color:#9af0c8}
  .tag.danger{border-color:#78343a;background:rgba(255,90,95,.08);color:#ffb7ba}
  .school .head{display:flex;align-items:center;gap:10px;margin-bottom:4px}
  .flex{display:flex;gap:10px;align-items:center}
  .input, select{
    appearance:none;background:#0d1523;border:1px solid #293449;color:#e9f2ff;border-radius:10px;
    padding:10px 12px;outline:none;min-height:42px
  }
  .input:focus,select:focus{box-shadow:0 0 0 3px var(--ring)}
  .danger-dot,.ok-dot,.warn-dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
  .danger-dot{background:var(--danger)} .ok-dot{background:var(--ok)} .warn-dot{background:var(--warn)}
  /* tiny helpers */
  .chx{display:flex;align-items:center;gap:10px}
  .chx input[type=checkbox]{width:18px;height:18px}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .dot.red{background:var(--danger)} .dot.orange{background:var(--warn)} .dot.green{background:var(--ok)}
  .badge.link{cursor:pointer;text-decoration:underline}
  /* AI bubble */
  #aiBox{position:fixed; right:18px; bottom:18px; z-index:40; display:none}
  #aiBox .bubble{
    background:linear-gradient(120deg, rgba(76,141,255,.22), rgba(122,108,255,.22));
    border:1px solid #2b3a5c; border-radius:16px; padding:14px 16px; max-width:300px;
    box-shadow:0 12px 40px rgba(0,0,0,.25); animation:float 6s ease-in-out infinite;
  }
  #aiBox .x{position:absolute; top:-8px; right:-8px; background:#0d1523;border:1px solid #25314a;color:#c9d9ff;
    width:28px;height:28px;border-radius:999px;display:flex;align-items:center;justify-content:center; cursor:pointer}
  @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)}}
</style>
</head>
<body>
  <div class="nav">
    <div class="row">
      <div class="brand">Pathwise</div>
      <div class="tabs">
        <button class="tab active" data-tab="dashboard">üè† Dashboard</button>
        <button class="tab" data-tab="planning">üìù Planning</button>
        <button class="tab" data-tab="documents">üìÑ Documents</button>
        <button class="tab" data-tab="timeline">üìÜ Timeline</button>
        <button class="tab" data-tab="aid">üí∞ Financial Aid</button>
      </div>
      <div class="grow"></div>
      <button id="themeBtn" class="btn">Toggle theme</button>
      <button class="btn" onclick="resetAll()">Reset all</button>
    </div>
  </div>

  <div class="app">
    <!-- DASHBOARD -->
    <section id="dashboard">
      <div class="h1">Welcome back, <span id="uName">Student</span>!</div>
      <div class="muted">Your personalized California college roadmap is ready.</div>

      <div class="grid" style="margin-top:14px">
        <div class="card stat k"><div class="name">Your GPA</div><div id="statGpa" class="val">‚Äî</div></div>
        <div class="card stat k"><div class="name">Target schools</div><div id="statSchools" class="val">‚Äî</div></div>
        <div class="card stat k"><div class="name">Days to UC/CSU deadline</div><div id="statDays" class="val">‚Äî</div></div>
      </div>

      <div class="h1" style="margin-top:18px">üéØ Your schools</div>
      <div class="row" id="viewFilters" style="margin:8px 0 12px">
        <button class="pill" data-mode="all" onclick="setViewMode('all')">All schools</button>
        <button class="pill sel" data-mode="my" onclick="setViewMode('my')">My list (<span id="myCount">0</span>)</button>
      </div>

      <div class="grid">
        <div class="k3">
          <div class="row" style="margin:8px 0 8px"><strong>Reach</strong><div class="muted">‚Äî aim high</div></div>
          <div id="reach" class="grid"></div>
        </div>
        <div class="k3" style="margin-top:12px">
          <div class="row" style="margin:8px 0 8px"><strong>Match</strong><div class="muted">‚Äî great fit</div></div>
          <div id="match" class="grid"></div>
        </div>
        <div class="k3" style="margin-top:12px">
          <div class="row" style="margin:8px 0 8px"><strong>Safety</strong><div class="muted">‚Äî solid backup</div></div>
          <div id="safety" class="grid"></div>
        </div>
      </div>
    </section>

    <!-- PLANNING -->
    <section id="planning" style="display:none">
      <div class="h1">Planning</div>
      <div class="grid" style="margin-top:10px">
        <div class="card k2">
          <div class="row"><strong>Profile</strong><div class="right"><button class="btn" onclick="resetPlanning()">Reset planning</button></div></div>
          <div class="grid" style="margin-top:12px">
            <div class="k">
              <div class="muted">GPA</div>
              <input id="inGpa" type="number" step="0.01" min="0" max="5" class="input" placeholder="e.g. 3.75">
            </div>
            <div class="k">
              <div class="muted">SAT (optional)</div>
              <input id="inSat" type="number" step="10" min="400" max="1600" class="input" placeholder="e.g. 1400">
            </div>
            <div class="k">
              <div class="muted">AP / Honors</div>
              <input id="inAp" type="number" step="1" min="0" class="input" placeholder="e.g. 4">
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <button class="btn primary" onclick="applyPlanning()">Save & update</button>
            <div class="muted">Updates your matches, documents, timeline and aid.</div>
          </div>
        </div>

        <div class="card k2">
          <strong>Quick tasks</strong>
          <div class="row" style="margin-top:8px">
            <input id="taskIn" class="input" placeholder="Add a task‚Ä¶">
            <button class="btn primary" onclick="addTask()">Add</button>
          </div>
          <ul id="taskList" style="list-style:none;margin:12px 0 0;padding:0"></ul>
        </div>
      </div>
    </section>

    <!-- DOCUMENTS -->
    <section id="documents" style="display:none">
      <div class="row">
        <div class="h1" style="margin:0">Documents</div>
        <div class="right"><button class="btn" onclick="aiDocs()">AI ‚Äî Help me write</button></div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="row"><div class="title"><strong>Documents checklist</strong> <span class="muted">‚Äî built from your schools</span></div></div>
        <div class="grid" id="documentsGrid" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- TIMELINE -->
    <section id="timeline" style="display:none">
      <div class="h1">Timeline</div>
      <div class="card" style="margin-top:10px">
        <div class="muted">Auto-generated from your selected schools + your doc due dates. Colors show urgency.</div>
        <div class="grid" id="timelineGrid" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- AID -->
    <section id="aid" style="display:none">
      <div class="h1">Financial aid estimate</div>
      <div class="card" style="margin-top:10px">
        <div class="grid">
          <div class="k">
            <div class="muted">Campus type</div>
            <select id="aidCampus">
              <option value="uc">UC (public)</option>
              <option value="csu">CSU (public)</option>
              <option value="private">Private (nonprofit)</option>
            </select>
          </div>
          <div class="k">
            <div class="muted">California resident?</div>
            <select id="aidResident">
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>
          <div class="k">
            <div class="muted">Family income (estimate)</div>
            <input id="aidIncome" type="number" class="input" placeholder="e.g. 75000">
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn primary" onclick="computeAid()">Compute aid</button>
          <div class="muted">Uses 2025-ish ranges; exact awards depend on FAFSA/CADAA + campus NPC.</div>
        </div>
        <div id="aidResults" style="margin-top:12px"></div>
        <div id="aidExtras" style="margin-top:6px"></div>
      </div>
    </section>
  </div>

  <!-- AI helper -->
  <div id="aiBox">
    <div class="x" onclick="document.getElementById('aiBox').style.display='none'">‚úï</div>
    <div class="bubble">Need help?</div>
  </div>

<script>
/* ---------- utilities ---------- */
const $=sel=>document.querySelector(sel);
const $$=sel=>Array.from(document.querySelectorAll(sel));
const today=()=>new Date();
const save=()=>localStorage.setItem("pathwiseUser", JSON.stringify(user));
function daysTo(dateStr){ const d=new Date(dateStr); return Math.max(0, Math.ceil((d-today())/(1000*60*60*24))); }

/* ---------- state ---------- */
let user = JSON.parse(localStorage.getItem("pathwiseUser")||"null") || {
  name:"Student", gpa:3.5, sat:1300, ap:3, selected:[]
};
let viewMode = "my";
const storedSel = JSON.parse(localStorage.getItem("selectedSchools")||"[]");
if(storedSel?.length){ user.selected = storedSel; }

/* ---------- school data (CA-heavy + privates) ---------- */
const SCHOOLS = [
  // UCs
  {id:1, name:"UC Berkeley", sector:"UC", rate:.15, avgGPA:4.25, avgSAT:1450, emphasis:"balanced",
   app:{EA:false,ED:false,RD:true}, req:{letters:0,essays:"UC PIQs (4)"}, npc:"https://npc.berkeley.edu/", coa:{tuition:14700, roomBoard:21000}},
  {id:2, name:"UCLA", sector:"UC", rate:.12, avgGPA:4.26, avgSAT:1445, emphasis:"balanced",
   app:{RD:true}, req:{letters:0,essays:"UC PIQs (4)"}, npc:"https://npc.ucla.edu/", coa:{tuition:13400, roomBoard:21000}},
  {id:3, name:"UC San Diego", sector:"UC", rate:.31, avgGPA:4.16, avgSAT:1410, emphasis:"scores",
   app:{RD:true}, req:{letters:0,essays:"UC PIQs (4)"}, npc:"https://students.ucsd.edu/finances/financial-aid/net-price-calculator.html", coa:{tuition:14600, roomBoard:20500}},
  {id:4, name:"UC Davis", sector:"UC", rate:.38, avgGPA:4.13, avgSAT:1350, emphasis:"balanced",
   app:{RD:true}, req:{letters:0,essays:"UC PIQs (4)"}, npc:"https://www.ucdavis.edu/admissions/undergraduate/tuition/net-price", coa:{tuition:14600, roomBoard:20000}},
  {id:5, name:"UC Irvine", sector:"UC", rate:.27, avgGPA:4.08, avgSAT:1360, emphasis:"balanced",
   app:{RD:true}, req:{letters:0,essays:"UC PIQs (4)"}, npc:"https://www.ofas.uci.edu/npc", coa:{tuition:13700, roomBoard:20500}},
  {id:6, name:"UC Santa Barbara", sector:"UC", rate:.30, avgGPA:4.15, avgSAT:1380, emphasis:"eca",
   app:{RD:true}, req:{letters:0,essays:"UC PIQs (4)"}, npc:"https://www.finaid.ucsb.edu/aid-estimator", coa:{tuition:14400, roomBoard:21900}},
  {id:7, name:"UC Santa Cruz", sector:"UC", rate:.51, avgGPA:3.96, avgSAT:1295, emphasis:"balanced",
   app:{RD:true}, req:{letters:0,essays:"UC PIQs (4)"}, npc:"https://admissions.ucsc.edu/costs/npc.html", coa:{tuition:14000, roomBoard:21000}},
  // CSU
  {id:20, name:"Cal Poly SLO", sector:"CSU", rate:.33, avgGPA:4.06, avgSAT:1395, emphasis:"scores",
   app:{RD:true}, req:{letters:0,essays:"None"}, npc:"https://npc.calpoly.edu/undergrad/", coa:{tuition:11000, roomBoard:20500}},
  {id:21, name:"San Diego State", sector:"CSU", rate:.38, avgGPA:3.85, avgSAT:1270, emphasis:"balanced",
   app:{RD:true}, req:{letters:0,essays:"None"}, npc:"https://www2.calstate.edu/attend/financial-aid/Pages/estimate-cost.aspx", coa:{tuition:8200, roomBoard:19800}},
  // Privates
  {id:101, name:"Stanford", sector:"Private", rate:.04, avgGPA:4.18, avgSAT:1520, emphasis:"balanced",
   app:{EA:true,ED:false,RD:true}, req:{letters:2,essays:"CommonApp + supplements"}, npc:"https://npc.stanford.edu/", coa:{tuition:62910, roomBoard:20000}},
  {id:102, name:"USC", sector:"Private", rate:.12, avgGPA:3.90, avgSAT:1450, emphasis:"eca",
   app:{EA:false,ED:false,RD:true}, req:{letters:1,essays:"CommonApp + supplements"}, npc:"https://financialaid.usc.edu/undergraduates/npc", coa:{tuition:68700, roomBoard:19100}},
  {id:103, name:"Pomona College", sector:"Private", rate:.07, avgGPA:4.00, avgSAT:1490, emphasis:"balanced",
   app:{EA:false,ED:true,RD:true}, req:{letters:2,essays:"CommonApp + supplements"}, npc:"https://npc.pomona.edu/", coa:{tuition:65300, roomBoard:20500}},
  {id:104, name:"Harvey Mudd", sector:"Private", rate:.14, avgGPA:4.10, avgSAT:1530, emphasis:"scores",
   app:{EA:false,ED:true,RD:true}, req:{letters:2,essays:"CommonApp + supplements"}, npc:"https://npc.hmc.edu/", coa:{tuition:66500, roomBoard:20800}},
  {id:105, name:"Santa Clara University", sector:"Private", rate:.54, avgGPA:3.70, avgSAT:1340, emphasis:"balanced",
   app:{EA:true,ED:false,RD:true}, req:{letters:1,essays:"CommonApp"}, npc:"https://www.scu.edu/financialaid/undergraduates/costs/net-price-calculator/", coa:{tuition:63600, roomBoard:20700}},
  {id:106, name:"Loyola Marymount (LMU)", sector:"Private", rate:.47, avgGPA:3.80, avgSAT:1300, emphasis:"eca",
   app:{EA:true,ED:false,RD:true}, req:{letters:1,essays:"CommonApp + supplement"}, npc:"https://npc.lmu.edu/", coa:{tuition:58800, roomBoard:21400}},
];

/* ---------- matching/score ---------- */
function scoreFor(s, gpa, sat){
  let score = 50;
  if(s.avgGPA){ score += (gpa - s.avgGPA) * 22; }
  if(s.avgSAT && sat){ score += (sat - s.avgSAT)/10; }
  if(s.emphasis==="scores" && sat){ score += 6; }
  if(s.emphasis==="eca"){ score += 3; }
  score += (user.ap||0)*1.5;
  return Math.max(5, Math.min(98, Math.round(score)));
}

/* ---------- rendering ---------- */
function cardHTML(s){
  const sc = scoreFor(s, user.gpa, user.sat);
  const inList = user.selected.includes(s.id);
  const cat = sc>=70 ? "ok" : sc<45 ? "danger" : "";
  const appTypes = Object.entries(s.app).filter(([k,v])=>v).map(([k])=>k.toUpperCase()).join(" / ") || "‚Äî";
  const focus = s.emphasis==="scores"?"Scores-heavy":s.emphasis==="eca"?"ECA-heavy":"Balanced";
  return `<div class="card school k">
    <div class="head"><strong>${s.name}</strong> <span class="tag ${cat}">${sc}% match</span></div>
    <div class="muted">${s.sector} ‚Ä¢ Admit ${(s.rate*100).toFixed(0)}% ‚Ä¢ Avg GPA ${s.avgGPA??"‚Äî"} ‚Ä¢ SAT ${s.avgSAT??"‚Äî"}</div>
    <div class="row" style="margin-top:6px">
      <span class="tag">${focus}</span>
      <span class="tag">App: ${appTypes}</span>
      <span class="tag">Req: ${s.req.letters||0} recs ‚Ä¢ ${s.req.essays}</span>
    </div>
    <div class="flex" style="margin-top:10px">
      <button class="btn ${inList?'':'primary'}" onclick="toggleSchool(${s.id})">${inList?'Remove':'Add'}</button>
      <button class="btn" onclick="openAidForSchool(${s.id})">Aid</button>
      <div class="right"></div>
    </div>
  </div>`;
}

function renderSchools(){
  const removed = JSON.parse(localStorage.getItem("removedSchools")||"[]");
  const catalog = SCHOOLS.filter(s=>!removed.includes(s.id));
  const list = (viewMode==="my" && user.selected.length) ? catalog.filter(s=>user.selected.includes(s.id)) : catalog;
  const buckets = {reach:[], match:[], safety:[]};

  list.forEach(s=>{
    const sc = scoreFor(s, user.gpa, user.sat);
    let b="match";
    const gdiff = user.gpa - (s.avgGPA||3.7);
    if(sc<45 || gdiff<-0.25) b="reach";
    else if(sc>=70 || gdiff>0.25) b="safety";
    buckets[b].push(cardHTML(s));
  });

  $("#reach").innerHTML = buckets.reach.join("") || `<div class="muted">None here yet.</div>`;
  $("#match").innerHTML = buckets.match.join("") || `<div class="muted">None here yet.</div>`;
  $("#safety").innerHTML = buckets.safety.join("") || `<div class="muted">None here yet.</div>`;
  $("#myCount").textContent = user.selected.length;
  $("#statSchools").textContent = user.selected.length.toString();
}

/* ---------- docs (generated) ---------- */
const DOC_MAP = {
  UC:      [{id:"uc_piq", label:"UC PIQs (4 essays)"},{id:"uc_app", label:"UC application"},{id:"transcripts", label:"Official transcripts"}],
  CSU:     [{id:"csu_app", label:"CSU application"},{id:"transcripts", label:"Official transcripts"}],
  Common:  [{id:"common_ps", label:"CommonApp personal statement"},{id:"common_app", label:"Common Application"}],
  Recs2:   [{id:"recs", label:"Letters of recommendation (2)"}],
  Recs1:   [{id:"recs", label:"Letter of recommendation (1)"}],
  Supp:    [{id:"supp", label:"School supplements"}],
  Test:    [{id:"scores", label:"Official test scores (if sending)"}]
};

function rebuildDocuments(){
  const chosen = SCHOOLS.filter(s=>user.selected.includes(s.id));
  const grid = $("#documentsGrid");
  if(!chosen.length){ grid.innerHTML = `<div class="muted">Add schools to build your checklist.</div>`; return; }

  const set = new Map();
  for(const s of chosen){
    if(s.sector==="UC") DOC_MAP.UC.forEach(d=>set.set(d.id,d));
    else if(s.sector==="CSU") DOC_MAP.CSU.forEach(d=>set.set(d.id,d));
    else{
      DOC_MAP.Common.forEach(d=>set.set(d.id,d));
      if(s.req?.letters>=2) DOC_MAP.Recs2.forEach(d=>set.set(d.id,d));
      else if(s.req?.letters>=1) DOC_MAP.Recs1.forEach(d=>set.set(d.id,d));
      DOC_MAP.Supp.forEach(d=>set.set(d.id,d));
      DOC_MAP.Test.forEach(d=>set.set(d.id,d));
    }
  }

  const saved = JSON.parse(localStorage.getItem("docStatus")||"{}");
  const items = Array.from(set.values());
  const rows = items.map(d=>{
    const st = saved[d.id]||{done:false,due:""};
    return `<div class="card k3">
      <div class="flex">
        <div class="chx">
          <input type="checkbox" ${st.done?"checked":""} onchange="markDoc('${d.id}',this.checked)">
          <div><strong>${d.label}</strong><div class="muted">${st.due?("Due "+st.due):"Set a due date"}</div></div>
        </div>
        <div class="right">
          <input type="date" class="input" style="width:180px" value="${st.due||""}" onchange="setDocDue('${d.id}',this.value)">
        </div>
      </div>
    </div>`;
  });

  grid.innerHTML = rows.join("");
  const pct = Math.round(100*items.filter(d=>(saved[d.id]||{}).done).length / Math.max(1,items.length));
  $("#documents .title").innerHTML = `<strong>Documents checklist</strong> <span class="muted">‚Äî <span style="font-weight:800">${pct}%</span> complete</span>`;
}

/* doc state helpers */
function markDoc(id, done){
  const saved = JSON.parse(localStorage.getItem("docStatus")||"{}");
  saved[id] = saved[id]||{};
  saved[id].done = !!done;
  localStorage.setItem("docStatus", JSON.stringify(saved));
  rebuildDocuments(); rebuildTimeline();
}
function setDocDue(id, date){
  const saved = JSON.parse(localStorage.getItem("docStatus")||"{}");
  saved[id] = saved[id]||{};
  saved[id].due = date;
  localStorage.setItem("docStatus", JSON.stringify(saved));
  rebuildDocuments(); rebuildTimeline();
}

/* ---------- timeline (generated) ---------- */
function schoolDeadlines(s){
  const items=[];
  if(s.sector==="UC" || s.sector==="CSU"){
    items.push({id:`${s.id}_deadline`, label:`${s.name} application deadline`, date:"2025-11-30"});
  } else {
    if(s.app?.EA) items.push({id:`${s.id}_ea`, label:`${s.name} Early Action`, date:"2025-11-01"});
    if(s.app?.ED) items.push({id:`${s.id}_ed`, label:`${s.name} Early Decision`, date:"2025-11-15"});
    if(s.app?.RD || (!s.app?.EA && !s.app?.ED)) items.push({id:`${s.id}_rd`, label:`${s.name} Regular Decision`, date:"2026-01-01"});
  }
  return items;
}

function rebuildTimeline(){
  const chosen = SCHOOLS.filter(s=>user.selected.includes(s.id));
  const grid = $("#timelineGrid");
  if(!chosen.length){ grid.innerHTML = `<div class="muted">Add schools to build your timeline.</div>`; return; }

  const docs = JSON.parse(localStorage.getItem("docStatus")||"{}");
  let events=[];
  chosen.forEach(s=>events=events.concat(schoolDeadlines(s)));
  Object.entries(docs).forEach(([id,st])=>{ if(st?.due) events.push({id:`doc_${id}`, label:`${id.replaceAll('_',' ').toUpperCase()}`, date:st.due}); });

  const now = new Date();
  const rows = events.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(ev=>{
    const d=new Date(ev.date); const days=Math.ceil((d-now)/(1000*60*60*24));
    const color = days<=7?"red":days<=21?"orange":"green";
    return `<div class="card k3">
      <div class="flex">
        <div><span class="dot ${color}"></span> <strong>${ev.label}</strong><div class="muted">${d.toDateString()}</div></div>
        <div class="right muted">${days>0?days+" days":"due"}</div>
      </div>
    </div>`;
  });
  grid.innerHTML = rows.join("");
}

/* ---------- aid ---------- */
function computeAid(){
  const campus = $("#aidCampus").value;     // uc, csu, private
  const resident = $("#aidResident").value === "yes";
  const income = parseInt($("#aidIncome").value||"0",10);
  const gpa = user.gpa||3.5;

  // Pell ‚Äî rough
  let pell = 0;
  if(income>0){
    if(income<=35000) pell = 7395;
    else if(income<=60000) pell = 3000;
  }

  // Cal Grant tuition awards (approx)
  let cal = 0;
  if(resident && gpa>=3.0){
    if(campus==="uc") cal = 13752;
    else if(campus==="csu") cal = 5742;
    else if(campus==="private") cal = 9500; // varies by sector; rough cap
  }
  const total = pell + cal;

  $("#aidResults").innerHTML = `
    <div class="card k3">
      <div class="grid">
        <div class="k3 row" style="justify-content:space-between"><div><strong>Estimated Federal Pell Grant</strong></div><div><strong>$${pell.toLocaleString()}</strong></div></div>
        <div class="k3 row" style="justify-content:space-between"><div><strong>Cal Grant (if eligible)</strong></div><div><strong>$${cal.toLocaleString()}</strong></div></div>
        <div class="k3 row" style="justify-content:space-between;border-top:1px solid var(--bord);padding-top:10px;margin-top:6px"><div><strong>Total estimated grant aid</strong></div><div><strong>$${total.toLocaleString()}</strong></div></div>
      </div>
      <div class="muted" style="margin-top:8px">Estimates only; use each school‚Äôs Net Price Calculator for precise awards.</div>
    </div>
  `;
}

function openAidForSchool(id){
  const s = SCHOOLS.find(x=>x.id===id);
  if(!s) return;
  const btn = $$(".tab").find(b=>b.dataset.tab==="aid");
  switchTab(btn); // switch
  $("#aidCampus").value = s.sector.toLowerCase()==="uc" ? "uc" : s.sector.toLowerCase()==="csu" ? "csu" : "private";
  computeAid();
  let extra = "";
  if(s.coa) extra += `<div class="muted">Est. COA: tuition ~$${(s.coa.tuition||0).toLocaleString()}, room+board ~$${(s.coa.roomBoard||0).toLocaleString()}</div>`;
  if(s.npc) extra += ` <a class="badge link" href="${s.npc}" target="_blank">Open ${s.name} Net Price Calculator</a>`;
  $("#aidExtras").innerHTML = extra;
  pokeAI("aid");
}

/* ---------- planning ---------- */
function applyPlanning(){
  const g=parseFloat($("#inGpa").value)||user.gpa;
  const s=parseInt($("#inSat").value||user.sat,10)||user.sat;
  const a=parseInt($("#inAp").value||user.ap,10)||user.ap;
  user.gpa=g; user.sat=s; user.ap=a; save();
  hydrateStats(); renderSchools(); rebuildDocuments(); rebuildTimeline(); computeAid();
  pokeAI("planning");
}
function resetPlanning(){
  $("#inGpa").value=""; $("#inSat").value=""; $("#inAp").value="";
  user.gpa=3.5; user.sat=1300; user.ap=3; save();
  hydrateStats(); renderSchools(); rebuildDocuments(); rebuildTimeline(); computeAid();
}

/* tasks */
function addTask(){
  const v=$("#taskIn").value.trim(); if(!v) return;
  const li=document.createElement("li");
  li.innerHTML=`<div class="row"><span>${v}</span><div class="right"><button class="btn" onclick="this.closest('li').remove(); persistTasks()">Done</button></div></div>`;
  $("#taskList").appendChild(li); $("#taskIn").value="";
  persistTasks();
}
function persistTasks(){
  const arr=[...$("#taskList").children].map(li=>li.innerText.replace("Done","").trim());
  localStorage.setItem("pathwiseTasks", JSON.stringify(arr));
}
function loadTasks(){
  const arr=JSON.parse(localStorage.getItem("pathwiseTasks")||"[]");
  $("#taskList").innerHTML="";
  arr.forEach(t=>{
    const li=document.createElement("li");
    li.innerHTML=`<div class="row"><span>${t}</span><div class="right"><button class="btn" onclick="this.closest('li').remove(); persistTasks()">Done</button></div></div>`;
    $("#taskList").appendChild(li);
  });
}

/* ---------- selection / view ---------- */
function toggleSchool(id){
  const i=user.selected.indexOf(id);
  if(i>-1) user.selected.splice(i,1); else user.selected.push(id);
  localStorage.setItem("selectedSchools", JSON.stringify(user.selected));
  $("#myCount").textContent=user.selected.length;
  renderSchools(); rebuildDocuments(); rebuildTimeline();
  pokeAI("documents");
}
function setViewMode(mode){
  viewMode=mode;
  $$("#viewFilters .pill").forEach(p=>p.classList.toggle("sel", p.dataset.mode===mode));
  renderSchools();
}

/* ---------- AI helper ---------- */
function pokeAI(page){
  const tips={
    dashboard:["Add 2 safeties first, then build reach/match.","Sort by match% and prune to 8‚Äì12 schools."],
    planning:["Small GPA gains shift matches; consider 1 AP.","Try a 4-week SAT sprint: 3 sets/week."],
    documents:["Start UC PIQs early: 1/week cadence.","Ask for recs 3‚Äì4 weeks ahead of deadlines."],
    timeline:["Back-plan 10‚Äì14 days for final edits.","Colors show urgency: red‚â§7d, orange‚â§21d."],
    aid:["If income ‚â§$35k, Pell often maxes.","Always run the school‚Äôs NPC for accuracy."]
  };
  const list=tips[page]||tips.dashboard;
  $("#aiBox .bubble").innerHTML=`<strong>Tip</strong><br>${list[Math.floor(Math.random()*list.length)]}`;
  $("#aiBox").style.display="block";
}
function aiDocs(){
  pokeAI("documents");
  $("#aiBox .bubble").innerHTML = `
    <strong>Writing helper</strong><br>
    Choose a template:<br>
    <button class="btn" style="margin-top:6px" onclick="openTemplate('uc')">UC PIQ outline</button>
    <button class="btn" style="margin-top:6px" onclick="openTemplate('common')">CommonApp outline</button>
    <button class="btn" style="margin-top:6px" onclick="openTemplate('rec')">Ask for a rec (email)</button>
  `;
}
function openTemplate(kind){
  const t={
    uc:`PIQ Prompt #X: [Theme]\n‚Ä¢ Context‚Ä¶\n‚Ä¢ Role‚Ä¶\n‚Ä¢ Actions‚Ä¶\n‚Ä¢ Impact‚Ä¶\n‚Ä¢ Reflection‚Ä¶\n(250‚Äì320 words each)`,
    common:`Hook ‚Üí Context ‚Üí Challenge ‚Üí Choices ‚Üí Change ‚Üí Meaning\n(600‚Äì650 words; 3‚Äì5 scenes, all yours)`,
    rec:`Subject: Recommendation request\n\nHi [Teacher],\nI enjoyed [class/moment]. I‚Äôm applying to [schools]; would you be willing to write a recommendation? I can share my resume + bullets. Deadline: [date].\nThank you!\n[Name]`
  };
  alert(t[kind]||"Template coming soon");
}

/* ---------- global ---------- */
function hydrateStats(){
  $("#uName").textContent = user.name||"Student";
  $("#statGpa").textContent = (user.gpa||0).toFixed(2);
  $("#statDays").textContent = daysTo("2025-11-30");
  $("#myCount").textContent = user.selected.length;
  $("#inGpa").placeholder=user.gpa.toFixed(2);
  $("#inSat").placeholder=user.sat||"";
  $("#inAp").placeholder=user.ap||"";
}
function resetAll(){
  if(!confirm("Reset everything (profile, tasks, selections)?")) return;
  localStorage.removeItem("pathwiseUser");
  localStorage.removeItem("pathwiseTasks");
  localStorage.removeItem("removedSchools");
  localStorage.removeItem("docStatus");
  localStorage.removeItem("selectedSchools");
  location.reload();
}

/* tabs */
function switchTab(btn){
  $$(".tab").forEach(b=>b.classList.toggle("active", b===btn));
  const name = btn.dataset.tab;
  ["dashboard","planning","documents","timeline","aid"].forEach(id=>{
    document.getElementById(id).style.display = (id===name) ? "" : "none";
  });
  // context AI nudge
  pokeAI(name);
}

/* theme */
(function(){
  const light = {
    '--bg':'#f6f8fc','--card':'#fff','--text':'#071018','--muted':'#72829d',
    '--bord':'#e6ecf5','--chip':'#f2f5fb','--pill':'#eef3fb','--pill-b':'#dbe6fb'
  };
  const dark = {}; // default
  const saved = localStorage.getItem("theme")||"dark";
  if(saved==="light") for(const k in light) document.documentElement.style.setProperty(k, light[k]);

  $("#themeBtn").onclick=()=>{
    const cur = localStorage.getItem("theme")||"dark";
    if(cur==="dark"){ for(const k in light) document.documentElement.style.setProperty(k, light[k]); localStorage.setItem("theme","light");}
    else{ for(const k in light) document.documentElement.style.removeProperty(k); localStorage.setItem("theme","dark");}
  };
})();

/* init */
function init(){
  // tab events
  $$(".tab").forEach(b=>b.addEventListener("click", e=>switchTab(b)));
  // load tasks
  loadTasks();
  // stats + renders
  hydrateStats(); renderSchools(); rebuildDocuments(); rebuildTimeline();
  // seed aid inputs
  $("#aidIncome").value = 75000;
  computeAid();
  // initial helper
  setTimeout(()=>pokeAI("dashboard"), 900);
}
init();
</script>
</body>
</html>
