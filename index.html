<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
/>
<title>Pathwise ‚Äî College Journey</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<style>
  :root{
    --bg:#f5f7fb;
    --card:#ffffff;
    --ink:#0f172a;
    --muted:#64748b;
    --primary:#0a84ff;      /* iOS blue */
    --primary-2:#5856d6;    /* iOS purple */
    --success:#34c759;
    --warn:#ff9500;
    --danger:#ff3b30;
    --ring:rgba(10,132,255,.25);
    --radius:14px;
    --radius-lg:20px;
    --shadow:0 8px 30px rgba(15,23,42,.08);
    --shadow-soft:0 2px 12px rgba(15,23,42,.06);
  }
  [data-theme="dark"]{
    --bg:#0b0e14;
    --card:#121826;
    --ink:#f8fafc;
    --muted:#94a3b8;
    --ring:rgba(10,132,255,.35);
    --shadow:0 8px 30px rgba(0,0,0,.45);
    --shadow-soft:0 2px 12px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Helvetica Neue",Arial,sans-serif;
    color:var(--ink);
    background:var(--bg);
    -webkit-font-smoothing:antialiased;
    line-height:1.45;
  }

  /* Header */
  .header{
    position:sticky; top:0; z-index:50;
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    background: color-mix(in srgb, var(--card) 88%, transparent);
    border-bottom:1px solid color-mix(in srgb, var(--ink) 10%, transparent);
  }
  .header-inner{
    max-width:1100px; margin:0 auto; padding:10px 16px;
    display:flex; align-items:center; gap:8px; justify-content:space-between;
  }
  .brand{display:flex; align-items:center; gap:10px; font-weight:700}
  .brand-badge{
    width:28px;height:28px;border-radius:8px;
    background:linear-gradient(135deg,var(--primary),var(--primary-2));
    box-shadow:var(--shadow-soft);
  }
  .header-actions{display:flex; align-items:center; gap:8px}
  .btn{
    appearance:none; border:0; cursor:pointer; user-select:none;
    display:inline-flex; align-items:center; justify-content:center;
    gap:8px; padding:12px 16px; border-radius:12px; font-weight:600;
    background:var(--card); color:var(--ink); box-shadow:var(--shadow-soft);
    transition:transform .12s ease, box-shadow .12s ease, background .12s ease, color .12s ease;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:var(--shadow)}
  .btn:active{transform:translateY(0)}
  .btn.primary{
    background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff;
  }
  .btn.ghost{
    background:transparent; box-shadow:none; border:1px solid color-mix(in srgb, var(--ink) 15%, transparent);
  }
  .btn.icon{padding:10px 12px; border-radius:10px}
  .btn.danger{background:var(--danger); color:#fff}
  .hidden{display:none !important}

  /* Shell */
  .wrap{max-width:1100px; margin:18px auto 80px; padding:0 16px}
  .card{
    background:var(--card);
    border-radius:var(--radius-lg);
    box-shadow:var(--shadow);
    padding:20px;
  }
  .title{font-size:22px; font-weight:800; margin:0 0 6px}
  .sub{color:var(--muted); font-size:14px; margin-bottom:14px}

  /* Planner */
  .grid{display:grid; gap:14px}
  @media(min-width:760px){ .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:repeat(3,1fr)} }
  .field label{font-size:12px; text-transform:uppercase; letter-spacing:.03em; color:var(--muted); display:block; margin-bottom:6px}
  .field input, .field select{
    width:100%; padding:14px 12px; border-radius:12px; border:1px solid color-mix(in srgb, var(--ink) 15%, transparent);
    background:var(--bg); color:var(--ink); outline: none;
  }
  .field input:focus, .field select:focus{ box-shadow:0 0 0 6px var(--ring); background:var(--card) }

  /* Tabs */
  .tabs{display:flex; gap:10px; overflow:auto; padding:10px 2px 2px}
  .tab{padding:10px 14px; border-radius:999px; background:var(--card); box-shadow:var(--shadow-soft); white-space:nowrap; cursor:pointer}
  .tab.active{ background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff }

  /* Buckets */
  .bucket{margin-top:18px}
  .bucket h3{display:flex; align-items:center; gap:10px; margin:0 0 8px}
  .badge{font-size:12px; padding:6px 10px; border-radius:999px; font-weight:700}
  .reach{ background: color-mix(in srgb, var(--danger) 15%, transparent); color:var(--danger) }
  .match{ background: color-mix(in srgb, var(--success) 15%, transparent); color:var(--success) }
  .safety{ background: color-mix(in srgb, var(--primary) 18%, transparent); color:var(--primary) }

  /* School cards */
  .schools{display:grid; gap:12px}
  @media(min-width:760px){ .schools{grid-template-columns:repeat(3,1fr)} }
  .school{
    position:relative; background:var(--card); border-radius:16px; padding:14px; box-shadow:var(--shadow-soft); border:1px solid color-mix(in srgb, var(--ink) 10%, transparent);
  }
  .school h4{margin:0 0 6px; font-size:16px}
  .muted{color:var(--muted); font-size:12px}
  .pill{position:absolute; top:10px; right:10px; font-size:11px; padding:6px 8px; border-radius:999px; background:color-mix(in srgb, var(--ink) 10%, transparent)}
  .actions{display:flex; gap:8px; margin-top:10px}
  .mini{padding:8px 10px; border-radius:10px; background:var(--bg); border:1px solid color-mix(in srgb, var(--ink) 15%, transparent); cursor:pointer}
  .mini.primary{ background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff; border:0 }

  /* Lists */
  .list{display:grid; gap:12px}
  .row{
    display:flex; align-items:center; gap:12px; justify-content:space-between;
    padding:12px; border-radius:12px; background:var(--bg); border:1px solid color-mix(in srgb, var(--ink) 15%, transparent);
  }
  .chip{padding:6px 10px; border-radius:999px; background:var(--card); box-shadow:var(--shadow-soft); border:1px solid color-mix(in srgb, var(--ink) 12%, transparent)}
  .progress{
    height:8px; width:100%; background:color-mix(in srgb, var(--ink) 10%, transparent);
    border-radius:999px; overflow:hidden;
  }
  .bar{height:100%; width:0; background:linear-gradient(90deg,var(--primary),var(--primary-2))}
  .flex{display:flex; gap:10px; align-items:center}
  .right{margin-left:auto}

  /* Timeline */
  .tl{display:grid; gap:10px}
  .tl-item{
    padding:12px; border-radius:12px; border-left:8px solid var(--primary);
    background:var(--bg); border:1px solid color-mix(in srgb, var(--ink) 15%, transparent);
  }
  .urg-red{ border-left-color: var(--danger) }
  .urg-orange{ border-left-color: var(--warn) }
  .urg-green{ border-left-color: var(--success) }

  /* AI bubble */
  .ai{
    position:fixed; right:16px; bottom:90px; z-index:60;
    background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff;
    padding:14px 16px; border-radius:16px; box-shadow:var(--shadow); cursor:pointer;
    animation:slidein .35s ease both;
  }
  .ai.small{bottom:20px; border-radius:50%; padding:12px}
  .ai p{margin:0; font-weight:700}
  @keyframes slidein{ from{ transform:translateY(12px); opacity:0 } to{ transform:translateY(0); opacity:1 } }

  /* Footer spacer for mobile */
  .spacer{height:40px}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-inner">
    <div class="brand">
      <div class="brand-badge"></div>
      <div>Pathwise</div>
    </div>
    <div class="header-actions">
      <button id="backPlanningBtn" class="btn ghost hidden">‚Üê Back to Planning</button>
      <button id="resetBtn" class="btn danger">Reset</button>
      <button id="themeBtn" class="btn icon" title="Toggle theme">üåô</button>
    </div>
  </div>
</div>

<div class="wrap">

  <!-- PLANNER -->
  <section id="planner" class="card">
    <h2 class="title">Plan your path</h2>
    <p class="sub">We‚Äôll tailor schools, costs, docs, and deadlines to you.</p>

    <div class="grid cols-2">
      <div class="field">
        <label>First name *</label>
        <input id="p_name" type="text" placeholder="Jordan" />
      </div>

      <div class="field">
        <label>Grade *</label>
        <select id="p_grade">
          <option value="">Select‚Ä¶</option>
          <option>9</option><option>10</option><option>11</option><option>12</option>
          <option value="transfer">Transfer</option>
        </select>
      </div>

      <div class="field">
        <label>Home state *</label>
        <select id="p_homeState">
          <option value="">Select‚Ä¶</option>
          <option value="CA">California</option>
          <option value="NY">New York</option>
          <option value="TX">Texas</option>
          <option value="MA">Massachusetts</option>
          <option value="IL">Illinois</option>
        </select>
      </div>

      <div class="field">
        <label>Household income (USD)</label>
        <input id="p_income" type="number" min="0" step="500" placeholder="75000" />
      </div>

      <div class="field">
        <label>GPA (weighted ok)</label>
        <input id="p_gpa" type="number" min="0" max="5" step="0.01" placeholder="3.85" />
      </div>

      <div class="field">
        <label>SAT (optional)</label>
        <input id="p_sat" type="number" min="400" max="1600" step="10" placeholder="1400" />
      </div>

      <div class="field">
        <label>AP/Honors count</label>
        <input id="p_ap" type="number" min="0" step="1" placeholder="5" />
      </div>

      <div class="field">
        <label>Target states (filter results)</label>
        <select id="p_states" multiple>
          <option value="CA">California</option>
          <option value="NY">New York</option>
          <option value="TX">Texas</option>
          <option value="MA">Massachusetts</option>
          <option value="IL">Illinois</option>
        </select>
      </div>
    </div>

    <div class="grid cols-3" style="margin-top:14px">
      <div class="field">
        <label>What matters most?</label>
        <select id="p_pref">
          <option value="">Balanced</option>
          <option value="reputation">Reputation</option>
          <option value="cost">Affordability</option>
          <option value="location">Location</option>
          <option value="size">Campus size</option>
        </select>
      </div>
      <div class="field">
        <label>Interests (quick set)</label>
        <select id="p_interest">
          <option value="">General</option>
          <option value="stem">STEM</option>
          <option value="arts">Arts</option>
          <option value="business">Business</option>
          <option value="health">Health</option>
          <option value="humanities">Humanities</option>
        </select>
      </div>
      <div class="field">
        <label>Email for reminders (optional)</label>
        <input id="p_email" type="email" placeholder="you@email.com" />
      </div>
    </div>

    <div class="flex" style="margin-top:12px">
      <button id="startBtn" class="btn primary">See my matches ‚Üí</button>
      <div class="chip" id="matchPreview">0 matches yet</div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard" class="hidden">
    <!-- Stats -->
    <div class="grid cols-3">
      <div class="card">
        <div class="muted">Your GPA</div>
        <div id="statGPA" class="title" style="margin:6px 0 0">‚Äî</div>
      </div>
      <div class="card">
        <div class="muted">My schools</div>
        <div id="statCount" class="title" style="margin:6px 0 0">0</div>
      </div>
      <div class="card">
        <div class="muted">Days to UC/CSU deadline (Nov 30, 2025)</div>
        <div id="statDays" class="title" style="margin:6px 0 0">‚Äî</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" style="margin-top:10px">
      <div data-tab="schools" class="tab active">Schools</div>
      <div data-tab="aid" class="tab">Financial Aid</div>
      <div data-tab="docs" class="tab">Documents</div>
      <div data-tab="timeline" class="tab">Timeline</div>
    </div>

    <!-- Schools tab -->
    <div id="tab-schools" class="card" style="margin-top:10px">
      <div class="grid cols-3">
        <div class="field">
          <label>Filter by state</label>
          <select id="f_state">
            <option value="">All</option>
            <option value="CA">CA</option><option value="NY">NY</option><option value="TX">TX</option><option value="MA">MA</option><option value="IL">IL</option>
          </select>
        </div>
        <div class="field">
          <label>System</label>
          <select id="f_sys">
            <option value="">Any</option>
            <option value="UC">UC</option><option value="CSU">CSU</option><option value="SUNY">SUNY</option><option value="UT">UT</option><option value="Private">Private</option>
          </select>
        </div>
        <div class="field">
          <label>Search</label>
          <input id="f_q" type="text" placeholder="Type to filter‚Ä¶" />
        </div>
      </div>

      <div id="bucket-reach" class="bucket">
        <h3><span class="badge reach">Reach ‚Ä¢ Shoot your shot</span></h3>
        <div class="schools" id="reachGrid"></div>
      </div>

      <div id="bucket-match" class="bucket">
        <h3><span class="badge match">Match ‚Ä¢ Great fit</span></h3>
        <div class="schools" id="matchGrid"></div>
      </div>

      <div id="bucket-safety" class="bucket">
        <h3><span class="badge safety">Safety ‚Ä¢ Solid W</span></h3>
        <div class="schools" id="safetyGrid"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="flex">
          <div class="title" style="font-size:18px">My Schools</div>
          <div class="right muted" id="mySchoolsHint">Add schools from the lists above</div>
        </div>
        <div id="mySchools" class="list" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- Aid tab -->
    <div id="tab-aid" class="card hidden" style="margin-top:10px">
      <h3 class="title" style="font-size:18px">Financial Aid ‚Äî per school</h3>
      <p class="sub">Uses household income, residency, and each state‚Äôs grant scaffolding.</p>
      <div id="aidList" class="list"></div>
    </div>

    <!-- Docs tab -->
    <div id="tab-docs" class="card hidden" style="margin-top:10px">
      <div class="flex">
        <h3 class="title" style="font-size:18px">Documents & Tasks</h3>
        <div class="chip right" id="docsProgress">0% done</div>
      </div>
      <div id="docList" class="list" style="margin-top:8px"></div>
    </div>

    <!-- Timeline tab -->
    <div id="tab-timeline" class="card hidden" style="margin-top:10px">
      <h3 class="title" style="font-size:18px">Timeline</h3>
      <p class="sub">Auto-built from your schools & documents.</p>
      <div id="tlList" class="tl"></div>
    </div>

  </section>

  <div class="spacer"></div>
</div>

<!-- AI helper -->
<div id="aiBubble" class="ai hidden" title="Need help?">
  <p>Need help picking schools?</p>
</div>

<script>
/* ===== Pathwise native bridge (drop-in) ===== */
(function () {
  const listeners = {};
  function emitToNative(type, payload = {}) {
    try {
      // iOS
      if (window.webkit?.messageHandlers?.pathwise) {
        window.webkit.messageHandlers.pathwise.postMessage({ type, payload });
      }
      // Android
      if (window.Android?.postMessage) {
        window.Android.postMessage(JSON.stringify({ type, payload }));
      }
    } catch (e) { /* no-op */ }
  }

  // Public API native can call (and web can also use internally)
  window.PathwiseBridge = {
    on(type, cb) { (listeners[type] ||= []).push(cb); },
    setUser(u)       { try { window.__pw_setUser?.(u); } catch{} },
    reset()          { try { window.__pw_reset?.(); } catch{} },
    navigate(dest)   { try { window.__pw_nav?.(dest); } catch{} }, // 'planner' | 'dashboard'
    setTheme(mode)   { try { document.documentElement.setAttribute('data-theme', mode);
                              localStorage.setItem('pw_theme', mode);} catch{} },
    selectSchools(ids){ try { window.__pw_selectSchools?.(ids); } catch{} },
    getState()       { try { return window.__pw_getState?.() || "{}"; } catch{ return "{}"; } }
  };

  window.__pw_emit_native = emitToNative;                   // web ‚Üí native
  window.__pw_emit_local  = (type,p)=>{ (listeners[type]||[]).forEach(cb=>cb(p)); };

  setTimeout(()=>emitToNative('ready', {}), 0);
})();

/* ========================
   DATA & UTILITIES
   ======================== */

const UI = {
  planner: document.getElementById('planner'),
  dashboard: document.getElementById('dashboard'),
  backPlanningBtn: document.getElementById('backPlanningBtn'),
  resetBtn: document.getElementById('resetBtn'),
  themeBtn: document.getElementById('themeBtn'),
  startBtn: document.getElementById('startBtn'),
  matchPreview: document.getElementById('matchPreview'),
  statGPA: document.getElementById('statGPA'),
  statCount: document.getElementById('statCount'),
  statDays: document.getElementById('statDays'),
  tabs: Array.from(document.querySelectorAll('.tab')),
  tabViews: {
    schools: document.getElementById('tab-schools'),
    aid: document.getElementById('tab-aid'),
    docs: document.getElementById('tab-docs'),
    timeline: document.getElementById('tab-timeline')
  },
  filters: {
    state: document.getElementById('f_state'),
    sys: document.getElementById('f_sys'),
    q: document.getElementById('f_q')
  },
  grids: {
    reach: document.getElementById('reachGrid'),
    match: document.getElementById('matchGrid'),
    safety: document.getElementById('safetyGrid')
  },
  mySchools: document.getElementById('mySchools'),
  mySchoolsHint: document.getElementById('mySchoolsHint'),
  aidList: document.getElementById('aidList'),
  docList: document.getElementById('docList'),
  docsProgress: document.getElementById('docsProgress'),
  tlList: document.getElementById('tlList'),
  aiBubble: document.getElementById('aiBubble'),
};

/* Expanded SCHOOLS (resident/non-resident tuition baked in) */
const SCHOOLS = [
  // UC
  {id:'ucb',name:'UC Berkeley',state:'CA',system:'UC',type:'public',city:'Berkeley',avgGPA:4.25,avgSAT:1450,acceptanceRate:14.5,tuitionResident:14226,tuitionNonResident:14226+32574,deadlines:{app:'Nov 30 2025',priority:'Nov 15 2025'},weights:{academics:.60,rigor:.20,eca:.10,essays:.10},requirements:{essays:4,recs:false,portfolio:false}},
  {id:'ucla',name:'UCLA',state:'CA',system:'UC',type:'public',city:'Los Angeles',avgGPA:4.26,avgSAT:1445,acceptanceRate:12.3,tuitionResident:13401,tuitionNonResident:13401+32574,deadlines:{app:'Nov 30 2025',priority:'Nov 15 2025'},weights:{academics:.58,rigor:.22,eca:.10,essays:.10},requirements:{essays:4,recs:false,portfolio:false}},
  {id:'ucsd',name:'UC San Diego',state:'CA',system:'UC',type:'public',city:'La Jolla',avgGPA:4.16,avgSAT:1410,acceptanceRate:31.5,tuitionResident:14616,tuitionNonResident:14616+32574,deadlines:{app:'Nov 30 2025',priority:'Nov 15 2025'},weights:{academics:.56,rigor:.22,eca:.12,essays:.10},requirements:{essays:4,recs:false,portfolio:false}},
  {id:'ucd',name:'UC Davis',state:'CA',system:'UC',type:'public',city:'Davis',avgGPA:4.13,avgSAT:1350,acceptanceRate:37.6,tuitionResident:14597,tuitionNonResident:14597+32574,deadlines:{app:'Nov 30 2025',priority:'Nov 15 2025'},weights:{academics:.54,rigor:.22,eca:.12,essays:.12},requirements:{essays:4,recs:false,portfolio:false}},
  {id:'uci',name:'UC Irvine',state:'CA',system:'UC',type:'public',city:'Irvine',avgGPA:4.08,avgSAT:1360,acceptanceRate:26.5,tuitionResident:13727,tuitionNonResident:13727+32574,deadlines:{app:'Nov 30 2025',priority:'Nov 15 2025'},weights:{academics:.54,rigor:.22,eca:.12,essays:.12},requirements:{essays:4,recs:false,portfolio:false}},
  {id:'ucsb',name:'UC Santa Barbara',state:'CA',system:'UC',type:'public',city:'Santa Barbara',avgGPA:4.15,avgSAT:1380,acceptanceRate:29.6,tuitionResident:14391,tuitionNonResident:14391+32574,deadlines:{app:'Nov 30 2025',priority:'Nov 15 2025'},weights:{academics:.54,rigor:.22,eca:.12,essays:.12},requirements:{essays:4,recs:false,portfolio:false}},
  {id:'ucsc',name:'UC Santa Cruz',state:'CA',system:'UC',type:'public',city:'Santa Cruz',avgGPA:3.96,avgSAT:1295,acceptanceRate:51.3,tuitionResident:13991,tuitionNonResident:13991+32574,deadlines:{app:'Nov 30 2025',priority:'Nov 15 2025'},weights:{academics:.52,rigor:.20,eca:.16,essays:.12},requirements:{essays:4,recs:false,portfolio:false}},
  // CSU
  {id:'cpslo',name:'Cal Poly SLO',state:'CA',system:'CSU',type:'public',city:'San Luis Obispo',avgGPA:4.06,avgSAT:1395,acceptanceRate:32.5,tuitionResident:10377,tuitionNonResident:10377+11880,deadlines:{app:'Nov 30 2025',priority:'Nov 15 2025'},weights:{academics:.52,rigor:.22,eca:.16,essays:.10},requirements:{essays:0,recs:false,portfolio:false}},
  {id:'sdsu',name:'San Diego State',state:'CA',system:'CSU',type:'public',city:'San Diego',avgGPA:3.85,avgSAT:1270,acceptanceRate:37.8,tuitionResident:7720,tuitionNonResident:7720+11880,deadlines:{app:'Nov 30 2025',priority:'Nov 15 2025'},weights:{academics:.50,rigor:.20,eca:.20,essays:.10},requirements:{essays:0,recs:false,portfolio:false}},
  {id:'csulb',name:'Cal State Long Beach',state:'CA',system:'CSU',type:'public',city:'Long Beach',avgGPA:3.8,avgSAT:1240,acceptanceRate:46,tuitionResident:7720,tuitionNonResident:7720+11880,deadlines:{app:'Nov 30 2025',priority:'Nov 15 2025'},weights:{academics:.48,rigor:.20,eca:.22,essays:.10},requirements:{essays:0,recs:false,portfolio:false}},
  // CA Privates
  {id:'stan',name:'Stanford University',state:'CA',system:'Private',type:'private',city:'Stanford',avgGPA:4.18,avgSAT:1520,acceptanceRate:4.0,tuitionResident:61650,tuitionNonResident:61650,deadlines:{app:'Jan 1 2026',priority:'Nov 1 2025'},weights:{academics:.55,rigor:.20,eca:.15,essays:.10},requirements:{essays:1,recs:true,portfolio:false}},
  {id:'usc',name:'USC',state:'CA',system:'Private',type:'private',city:'Los Angeles',avgGPA:3.9,avgSAT:1460,acceptanceRate:10.5,tuitionResident:68337,tuitionNonResident:68337,deadlines:{app:'Jan 15 2026',priority:'Dec 1 2025'},weights:{academics:.52,rigor:.20,eca:.18,essays:.10},requirements:{essays:1,recs:true,portfolio:false}},
  {id:'caltech',name:'Caltech',state:'CA',system:'Private',type:'private',city:'Pasadena',avgGPA:4.2,avgSAT:1560,acceptanceRate:3.0,tuitionResident:65394,tuitionNonResident:65394,deadlines:{app:'Jan 3 2026',priority:'Nov 1 2025'},weights:{academics:.65,rigor:.20,eca:.10,essays:.05},requirements:{essays:1,recs:true,portfolio:false}},
  {id:'pomona',name:'Pomona College',state:'CA',system:'Private',type:'private',city:'Claremont',avgGPA:3.95,avgSAT:1500,acceptanceRate:7.0,tuitionResident:63540,tuitionNonResident:63540,deadlines:{app:'Jan 8 2026',priority:'Nov 1 2025'},weights:{academics:.55,rigor:.18,eca:.17,essays:.10},requirements:{essays:1,recs:true,portfolio:false}},
  // NY SUNY & privates
  {id:'suny-bing',name:'SUNY Binghamton',state:'NY',system:'SUNY',type:'public',city:'Binghamton',avgGPA:3.8,avgSAT:1350,acceptanceRate:44,tuitionResident:7360,tuitionNonResident:26290,deadlines:{app:'Jan 15 2026',priority:'Nov 1 2025'},weights:{academics:.52,rigor:.22,eca:.16,essays:.10},requirements:{essays:1,recs:true,portfolio:false}},
  {id:'suny-sb',name:'SUNY Stony Brook',state:'NY',system:'SUNY',type:'public',city:'Stony Brook',avgGPA:3.8,avgSAT:1370,acceptanceRate:48,tuitionResident:7360,tuitionNonResident:26290,deadlines:{app:'Jan 15 2026',priority:'Nov 1 2025'},weights:{academics:.52,rigor:.22,eca:.16,essays:.10},requirements:{essays:1,recs:true,portfolio:false}},
  {id:'suny-buff',name:'SUNY Buffalo (UB)',state:'NY',system:'SUNY',type:'public',city:'Buffalo',avgGPA:3.7,avgSAT:1290,acceptanceRate:67,tuitionResident:7360,tuitionNonResident:26290,deadlines:{app:'Feb 1 2026',priority:'Nov 15 2025'},weights:{academics:.50,rigor:.22,eca:.18,essays:.10},requirements:{essays:1,recs:true,portfolio:false}},
  {id:'suny-gen',name:'SUNY Geneseo',state:'NY',system:'SUNY',type:'public',city:'Geneseo',avgGPA:3.7,avgSAT:1270,acceptanceRate:65,tuitionResident:7360,tuitionNonResident:18240,deadlines:{app:'Jan 15 2026',priority:'Nov 1 2025'},weights:{academics:.48,rigor:.20,eca:.22,essays:.10},requirements:{essays:1,recs:true,portfolio:false}},
  {id:'nyu',name:'New York University',state:'NY',system:'Private',type:'private',city:'New York',avgGPA:3.8,avgSAT:1500,acceptanceRate:12.5,tuitionResident:58960,tuitionNonResident:58960,deadlines:{app:'Jan 5 2026',priority:'Nov 1 2025'},weights:{academics:.52,rigor:.18,eca:.20,essays:.10},requirements:{essays:1,recs:true,portfolio:false}},
  // TX UT / TAMU / Rice
  {id:'uta',name:'UT Austin',state:'TX',system:'UT',type:'public',city:'Austin',avgGPA:3.9,avgSAT:1370,acceptanceRate:31,tuitionResident:11500,tuitionNonResident:40000,deadlines:{app:'Dec 1 2025',priority:'Nov 1 2025'},weights:{academics:.55,rigor:.20,eca:.15,essays:.10},requirements:{essays:2,recs:false,portfolio:false}},
  {id:'utd',name:'UT Dallas',state:'TX',system:'UT',type:'public',city:'Richardson',avgGPA:3.7,avgSAT:1320,acceptanceRate:79,tuitionResident:14600,tuitionNonResident:39500,deadlines:{app:'Jul 1 2026',priority:'May 1 2026'},weights:{academics:.50,rigor:.20,eca:.20,essays:.10},requirements:{essays:1,recs:false,portfolio:false}},
  {id:'tamu',name:'Texas A&M ‚Äî College Station',state:'TX',system:'TAMU',type:'public',city:'College Station',avgGPA:3.7,avgSAT:1270,acceptanceRate:63,tuitionResident:13900,tuitionNonResident:40900,deadlines:{app:'Dec 1 2025',priority:'Nov 1 2025'},weights:{academics:.50,rigor:.22,eca:.18,essays:.10},requirements:{essays:1,recs:false,portfolio:false}},
  {id:'rice',name:'Rice University',state:'TX',system:'Private',type:'private',city:'Houston',avgGPA:3.95,avgSAT:1530,acceptanceRate:7.0,tuitionResident:57600,tuitionNonResident:57600,deadlines:{app:'Jan 4 2026',priority:'Nov 1 2025'},weights:{academics:.55,rigor:.20,eca:.15,essays:.10},requirements:{essays:1,recs:true,portfolio:false}},
  // MA
  {id:'umass',name:'UMass Amherst',state:'MA',system:'UMass',type:'public',city:'Amherst',avgGPA:3.9,avgSAT:1310,acceptanceRate:66,tuitionResident:16952,tuitionNonResident:39224,deadlines:{app:'Jan 15 2026',priority:'Nov 5 2025'},weights:{academics:.50,rigor:.22,eca:.18,essays:.10},requirements:{essays:1,recs:true,portfolio:false}},
  {id:'neu',name:'Northeastern',state:'MA',system:'Private',type:'private',city:'Boston',avgGPA:4.0,avgSAT:1490,acceptanceRate:7.0,tuitionResident:63700,tuitionNonResident:63700,deadlines:{app:'Jan 1 2026',priority:'Nov 1 2025'},weights:{academics:.52,rigor:.18,eca:.20,essays:.10},requirements:{essays:1,recs:true,portfolio:false}},
  {id:'bu',name:'Boston University',state:'MA',system:'Private',type:'private',city:'Boston',avgGPA:3.9,avgSAT:1470,acceptanceRate:14,tuitionResident:65700,tuitionNonResident:65700,deadlines:{app:'Jan 4 2026',priority:'Nov 1 2025'},weights:{academics:.52,rigor:.18,eca:.20,essays:.10},requirements:{essays:1,recs:true,portfolio:false}},
  // IL
  {id:'uiuc',name:'UIUC',state:'IL',system:'UI',type:'public',city:'Urbana‚ÄìChampaign',avgGPA:3.8,avgSAT:1430,acceptanceRate:45,tuitionResident:17000,tuitionNonResident:36000,deadlines:{app:'Jan 5 2026',priority:'Nov 1 2025'},weights:{academics:.54,rigor:.20,eca:.16,essays:.10},requirements:{essays:2,recs:false,portfolio:false}},
  {id:'uic',name:'UIC',state:'IL',system:'UI',type:'public',city:'Chicago',avgGPA:3.6,avgSAT:1210,acceptanceRate:73,tuitionResident:16400,tuitionNonResident:33200,deadlines:{app:'Mar 1 2026',priority:'Nov 1 2025'},weights:{academics:.48,rigor:.20,eca:.22,essays:.10},requirements:{essays:1,recs:false,portfolio:false}},
  {id:'northwestern',name:'Northwestern',state:'IL',system:'Private',type:'private',city:'Evanston',avgGPA:4.1,avgSAT:1520,acceptanceRate:7.0,tuitionResident:66800,tuitionNonResident:66800,deadlines:{app:'Jan 2 2026',priority:'Nov 1 2025'},weights:{academics:.56,rigor:.20,eca:.14,essays:.10},requirements:{essays:1,recs:true,portfolio:false}},
];

/* Aid tables (placeholder bands; swap with exact current-year later) */
const AID_TABLES = {
  PELL: [[30000,7395],[45000,4500],[60000,1500]],
  CA: { calGrantA:{minGPA:3.0,incomeMax:125000,amountUC:12570,amountCSU:5742,amountPrivate:9850},
        mcs:{incomeMax:217000,approxAmount:2500} },
  NY: { tap:[[80000,5500],[100000,3000]] },
  TX: { texasGrant:[[70000,5000],[90000,2500]] },
  MA: { massGrant:[[80000,2000],[100000,1000]] },
  IL: { map:[[70000,5400],[90000,2500]] },
};

const LS_KEYS = {
  user:'pw_user',
  my:'pw_my_schools',
  docs:'pw_docs',
  theme:'pw_theme'
};

let user = null;
let mySchools = [];         // array of school ids
let docState = {};          // { [docKey]: {done:boolean, due:string, label:string, schoolId?:string } }

/* ========================
   HELPERS
   ======================== */
const $ = s => document.querySelector(s);
function daysUntil(dateStr){
  const now = new Date();
  const d = new Date(dateStr);
  return Math.floor((d - now)/(1000*60*60*24));
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)) }
function isResident(school){ return !!(user && school && user.homeState === school.state) }
function tuitionFor(school){
  return isResident(school) ? school.tuitionResident : school.tuitionNonResident;
}
function bandedAmount(bands,income){ for(const [cap,amt] of bands){ if(income<=cap) return amt } return 0 }
function pellAmount(income){ return bandedAmount(AID_TABLES.PELL, income||0) }
function stateGrant(state,resident,gpa,income,system,type){
  const items=[]; if(!resident) return {items,total:0};
  switch(state){
    case 'CA':{
      const {calGrantA,mcs}=AID_TABLES.CA;
      if(gpa>=calGrantA.minGPA && income<=calGrantA.incomeMax){
        let amt=0;
        if(system==='UC') amt=calGrantA.amountUC;
        else if(system==='CSU') amt=calGrantA.amountCSU;
        else if(type==='private') amt=calGrantA.amountPrivate;
        if(amt) items.push({label:'Cal Grant A (est.)',amount:amt});
      }
      if(income<=mcs.incomeMax){ items.push({label:'Middle Class Scholarship (approx.)',amount:mcs.approxAmount}); }
      break;
    }
    case 'NY':{
      const t=bandedAmount(AID_TABLES.NY.tap, income||0);
      if(t) items.push({label:'NYS TAP (est.)',amount:t});
      break;
    }
    case 'TX':{
      const g=bandedAmount(AID_TABLES.TX.texasGrant, income||0);
      if(g && type==='public') items.push({label:'TEXAS Grant (est.)',amount:g});
      break;
    }
    case 'MA':{
      const m=bandedAmount(AID_TABLES.MA.massGrant, income||0);
      if(m) items.push({label:'MASSGrant (est.)',amount:m});
      break;
    }
    case 'IL':{
      const m=bandedAmount(AID_TABLES.IL.map, income||0);
      if(m) items.push({label:'Illinois MAP (est.)',amount:m});
      break;
    }
  }
  const total = items.reduce((s,i)=>s+i.amount,0);
  return {items,total};
}
function computeAidForSchool(school){
  const income = Number(user.householdIncome||0);
  const pell = pellAmount(income);
  const sg = stateGrant(school.state, isResident(school), Number(user.gpa||0), income, school.system, school.type);
  return { items:[{label:'Federal Pell (est.)',amount:pell}, ...sg.items], total: pell + sg.total };
}

/* ========================
   BUCKETING & MATCH
   ======================== */
function matchScore(school){
  let s=50;
  const gpa = Number(user.gpa||0);
  const sat = Number(user.sat||0);
  if(gpa){
    const g = clamp((gpa - school.avgGPA) * 20, -40, 40);
    s += g;
  }
  if(sat){
    const d = clamp((sat - school.avgSAT) / 10, -20, 20);
    s += d;
  }
  // AP/Rigor
  const ap = Number(user.ap||0);
  s += clamp(ap*1.5, 0, 12);

  // Preference nudge
  if(user.pref==='reputation' && school.acceptanceRate<30) s+=6;
  if(user.pref==='cost' && tuitionFor(school) < 15000) s+=8;

  // Interest nudge (STEM ‚Üí UC/Caltech/Stanford/UT)
  if(user.interest==='stem' && (school.system==='UC' || ['stan','caltech','uta','utd','tamu','uiuc'].includes(school.id))) s+=6;

  return clamp(Math.round(s),0,100);
}
function bucketFor(school){
  const s = matchScore(school);
  const gpa = Number(user.gpa||0);
  const gdiff = gpa ? gpa - (school.avgGPA||gpa) : 0;
  if (gdiff < -0.25 || s < 45) return 'reach';
  if (gdiff > 0.25 || s > 70) return 'safety';
  return 'match';
}

/* ========================
   DOCS & TIMELINE BUILDERS
   ======================== */
function makeDocsForSchool(s){
  // requirements map ‚Üí interactive tasks
  const items = [];
  items.push({key:`${s.id}_profile`, label:`${s.name}: application info`, due:s.deadlines.priority||s.deadlines.app});
  if(s.requirements.essays>0) items.push({key:`${s.id}_essays`, label:`${s.name}: essays (${s.requirements.essays})`, due:addDays(s.deadlines.app,-15)});
  if(s.requirements.recs) items.push({key:`${s.id}_recs`, label:`${s.name}: 2 recommendations`, due:addDays(s.deadlines.app,-21)});
  items.push({key:`${s.id}_transcript`, label:`${s.name}: transcript request`, due:addDays(s.deadlines.app,-30)});
  // FAFSA (once per state key)
  if(['CA','NY','TX','MA','IL'].includes(user.homeState||'')){
    items.push({key:`fafsa_${s.state}`, label:`FAFSA for ${s.state}`, due:(s.state==='CA'?'Oct 1 2025':'Oct 1 2025')});
  }
  return items;
}
function addDays(dateStr, delta){
  const d = new Date(dateStr); d.setDate(d.getDate()+delta); 
  const opts = {month:'short', day:'numeric', year:'numeric'};
  return d.toLocaleDateString('en-US', opts);
}
function urgencyClass(dateStr){
  const d = daysUntil(dateStr);
  if (d <= 14) return 'urg-red';
  if (d <= 30) return 'urg-orange';
  return 'urg-green';
}

/* ========================
   LOCAL STORAGE
   ======================== */
function saveAll(){
  localStorage.setItem(LS_KEYS.user, JSON.stringify(user));
  localStorage.setItem(LS_KEYS.my, JSON.stringify(mySchools));
  localStorage.setItem(LS_KEYS.docs, JSON.stringify(docState));
}
function loadAll(){
  try{
    user = JSON.parse(localStorage.getItem(LS_KEYS.user) || 'null');
    mySchools = JSON.parse(localStorage.getItem(LS_KEYS.my) || '[]');
    docState = JSON.parse(localStorage.getItem(LS_KEYS.docs) || '{}');
  }catch(e){ user=null; mySchools=[]; docState={}; }
}

/* ========================
   RENDERING
   ======================== */
function renderPlanner(){
  UI.planner.classList.remove('hidden');
  UI.dashboard.classList.add('hidden');
  UI.backPlanningBtn.classList.add('hidden');
  // blank slate fields
  if(!user){
    $('#p_name').value='';
    $('#p_grade').value='';
    $('#p_homeState').value='';
    $('#p_income').value='';
    $('#p_gpa').value='';
    $('#p_sat').value='';
    $('#p_ap').value='';
    $('#p_pref').value='';
    $('#p_interest').value='';
    { const sel = $('#p_states'); Array.from(sel.options).forEach(o => o.selected = false); }
    UI.matchPreview.textContent = '0 matches yet';
  }else{
    // preload
    $('#p_name').value = user.name||'';
    $('#p_grade').value = user.grade||'';
    $('#p_homeState').value = user.homeState||'';
    $('#p_income').value = user.householdIncome||'';
    $('#p_gpa').value = user.gpa||'';
    $('#p_sat').value = user.sat||'';
    $('#p_ap').value = user.ap||'';
    $('#p_pref').value = user.pref||'';
    $('#p_interest').value = user.interest||'';
    const sel = $('#p_states');
    const states = user.targetStates||[];
    Array.from(sel.options).forEach(o => { o.selected = states.includes(o.value) });
  }
}
function renderDashboard(){
  UI.planner.classList.add('hidden');
  UI.dashboard.classList.remove('hidden');
  UI.backPlanningBtn.classList.remove('hidden');

  // stats
  UI.statGPA.textContent = user.gpa ? Number(user.gpa).toFixed(2) : '‚Äî';
  const dleft = daysUntil('Nov 30 2025'); UI.statDays.textContent = dleft>0 ? dleft : 0;

  // first tab default
  setActiveTab('schools');
  renderSchoolsTab();
  renderAidTab();
  renderDocsTab();
  renderTimelineTab();
}
function setActiveTab(name){
  UI.tabs.forEach(t=>{
    const is = t.dataset.tab===name;
    t.classList.toggle('active', is);
    UI.tabViews[t.dataset.tab].classList.toggle('hidden', !is);
  });
}

/* Schools tab */
function renderSchoolsTab(){
  // filters
  const fState = UI.filters.state.value;
  const fSys = UI.filters.sys.value;
  const q = UI.filters.q.value.toLowerCase();

  // filter to target states if set in planner
  const allowStates = (user.targetStates && user.targetStates.length>0) ? new Set(user.targetStates) : null;

  const pool = SCHOOLS.filter(s=>{
    if(allowStates && !allowStates.has(s.state)) return false;
    if(fState && s.state!==fState) return false;
    if(fSys && s.system!==fSys) return false;
    if(q && !(`${s.name} ${s.city} ${s.system}`.toLowerCase().includes(q))) return false;
    return true;
  });

  const reach=[], match=[], safety=[];
  pool.forEach(s=>{
    const b = bucketFor(s);
    const card = schoolCard(s);
    if(b==='reach') reach.push(card); else if(b==='match') match.push(card); else safety.push(card);
  });

  UI.grids.reach.innerHTML = reach.join('') || `<div class="muted">No reach results</div>`;
  UI.grids.match.innerHTML = match.join('') || `<div class="muted">No match results</div>`;
  UI.grids.safety.innerHTML = safety.join('') || `<div class="muted">No safety results</div>`;

  // my schools
  if(mySchools.length===0){
    UI.mySchools.innerHTML = '';
    UI.mySchoolsHint.textContent = 'Add schools from the lists above';
  }else{
    UI.mySchoolsHint.textContent = '';
    UI.mySchools.innerHTML = mySchools.map(id=>{
      const s=SCHOOLS.find(x=>x.id===id);
      const aid = computeAidForSchool(s);
      return `
        <div class="row">
          <div>
            <div style="font-weight:700">${s.name}</div>
            <div class="muted" style="font-size:12px">${s.city}, ${s.state} ‚Ä¢ ${s.system} ‚Ä¢ Tuition ${isResident(s)?'Resident':'Non-Res'}: $${tuitionFor(s).toLocaleString()}</div>
          </div>
          <span class="chip">Aid est: $${aid.total.toLocaleString()}</span>
          <button class="mini" onclick="removeSchool('${s.id}')">Remove</button>
        </div>
      `;
    }).join('');
  }

  UI.statCount.textContent = String(mySchools.length);
}
function schoolCard(s){
  const score = matchScore(s);
  const badge = `<span class="pill">${score}% match</span>`;
  const tuition = tuitionFor(s);
  const btnLabel = mySchools.includes(s.id) ? 'Added' : 'Add';
  const btnState = mySchools.includes(s.id) ? 'disabled' : '';
  return `
    <div class="school">
      ${badge}
      <h4>${s.name}</h4>
      <div class="muted">${s.city}, ${s.state} ‚Ä¢ ${s.system} ‚Ä¢ ${s.type}</div>
      <div class="muted" style="margin-top:6px">Avg GPA ${s.avgGPA} ‚Ä¢ SAT ${s.avgSAT} ‚Ä¢ Admit ${s.acceptanceRate}%</div>
      <div class="muted" style="margin-top:4px">Tuition ${isResident(s)?'Resident':'Non-Res'}: <b>$${tuition.toLocaleString()}</b>/yr</div>
      <div class="actions">
        <button class="mini primary" ${btnState} onclick="addSchool('${s.id}')">${btnLabel}</button>
        <button class="mini" onclick="quickAid('${s.id}')">Aid</button>
        <button class="mini" onclick="quickReq('${s.id}')">Reqs</button>
      </div>
    </div>
  `;
}
function addSchool(id){
  if(!mySchools.includes(id)){ mySchools.push(id); saveAll(); renderSchoolsTab(); renderAidTab(); renderDocsTab(); renderTimelineTab(); }
}
function removeSchool(id){
  mySchools = mySchools.filter(x=>x!==id); saveAll();
  renderSchoolsTab(); renderAidTab(); renderDocsTab(); renderTimelineTab();
}
function quickAid(id){
  setActiveTab('aid'); renderAidTab();
  aiPing("I broke down your aid per school ‚Äî want me to explain Pell vs state grants?");
}
function quickReq(id){
  setActiveTab('docs'); renderDocsTab();
  aiPing("Need a nudge on essays or recs? I can draft prompts or request templates.");
}

/* Aid tab */
function renderAidTab(){
  if(mySchools.length===0){ UI.aidList.innerHTML = `<div class="muted">Add schools to see aid estimates.</div>`; return; }
  UI.aidList.innerHTML = mySchools.map(id=>{
    const s=SCHOOLS.find(x=>x.id===id);
    const aid = computeAidForSchool(s);
    const rows = aid.items.map(i=>`<div class="row"><div>${i.label}</div><div style="font-weight:700">$${i.amount.toLocaleString()}</div></div>`).join('');
    return `
      <div class="card">
        <div class="flex">
          <div>
            <div class="title" style="font-size:18px">${s.name}</div>
            <div class="muted" style="font-size:12px">${isResident(s)?'Resident':'Non-Resident'} ‚Ä¢ Tuition: $${tuitionFor(s).toLocaleString()}</div>
          </div>
          <div class="chip right">Aid est: $${aid.total.toLocaleString()}</div>
        </div>
        <div class="list" style="margin-top:10px">${rows}</div>
      </div>
    `;
  }).join('');
}

/* Docs tab (dedup by key) */
function renderDocsTab(){
  // Build docs per selected school, but de-duplicate by key
  const docMap = new Map();

  mySchools.forEach(id=>{
    const s=SCHOOLS.find(x=>x.id===id);
    makeDocsForSchool(s).forEach(d=>{
      if(!docMap.has(d.key)) docMap.set(d.key, {...d, schoolId:s.id});
      if(!(d.key in docState)){
        docState[d.key] = {done:false,label:d.label,due:d.due,schoolId:s.id};
      }
    });
  });
  saveAll();

  const docs = Array.from(docMap.values());
  if(docs.length===0){
    UI.docList.innerHTML = `<div class="muted">Add schools to generate your checklist.</div>`;
    UI.docsProgress.textContent='0% done';
    return;
  }

  let done=0;
  UI.docList.innerHTML = docs.map(d=>{
    const st = docState[d.key] || {done:false,label:d.label,due:d.due,schoolId:d.schoolId};
    if(st.done) done++;
    return `
      <div class="row">
        <div class="flex">
          <input type="checkbox" ${st.done?'checked':''} onchange="toggleDoc('${d.key}',this.checked)"/>
          <div>
            <div style="font-weight:700">${st.label}</div>
            <div class="muted" style="font-size:12px">Due: ${st.due}</div>
          </div>
        </div>
        ${d.key.includes('_essays') ? `<button class="mini" onclick="aiPing('Want help brainstorming essay topics for ${SCHOOLS.find(x=>x.id===d.schoolId).name}?')">Help me write</button>`:''}
      </div>
    `;
  }).join('');

  const pct = Math.round((done/docs.length)*100);
  UI.docsProgress.textContent = `${pct}% done`;
}
function toggleDoc(key,checked){
  if(!docState[key]) return;
  docState[key].done = checked;
  saveAll();
  renderDocsTab(); renderTimelineTab();
}

/* Timeline tab */
function renderTimelineTab(){
  const items = [];
  mySchools.forEach(id=>{
    const s=SCHOOLS.find(x=>x.id===id);
    if(s.deadlines.priority) items.push({label:`${s.name}: Priority submit`, date:s.deadlines.priority});
    if(s.deadlines.app) items.push({label:`${s.name}: Final deadline`, date:s.deadlines.app});
  });
  Object.keys(docState).forEach(k=>{
    const d=docState[k];
    items.push({label:d.label, date:d.due, done:d.done});
  });
  if(user && user.homeState){
    items.push({label:`FAFSA opens`, date:'Oct 1 2025'});
  }

  items.sort((a,b)=> new Date(a.date) - new Date(b.date));

  if(items.length===0){ UI.tlList.innerHTML = `<div class="muted">Add schools to see your timeline.</div>`; return; }
  UI.tlList.innerHTML = items.map(it=>{
    const cls = it.done ? 'urg-green' : urgencyClass(it.date);
    return `
      <div class="tl-item ${cls}">
        <div style="display:flex; align-items:center; gap:10px">
          <div style="font-weight:700">${it.label}</div>
          <div class="chip">${it.date}</div>
          <div class="right muted">${daysUntil(it.date)} days</div>
        </div>
      </div>
    `;
  }).join('');
}

/* ========================
   AI HELPER (lightweight)
   ======================== */
let idleTimer=null;
function scheduleAI(){
  clearTimeout(idleTimer);
  idleTimer = setTimeout(()=>{
    UI.aiBubble.innerHTML = `<p>Want me to suggest a school list?</p>`;
    UI.aiBubble.classList.remove('hidden');
  }, 45000); // 45s idle
}
function aiPing(msg){
  UI.aiBubble.innerHTML = `<p>${msg}</p>`;
  UI.aiBubble.classList.remove('hidden');
  setTimeout(()=>UI.aiBubble.classList.add('hidden'), 8000);
}

/* ========================
   RESET (shared)
   ======================== */
function resetAll(){
  localStorage.removeItem(LS_KEYS.user);
  localStorage.removeItem(LS_KEYS.my);
  localStorage.removeItem(LS_KEYS.docs);
  user=null; mySchools=[]; docState={};
  renderPlanner();
  aiPing("Fresh slate ‚Äî let‚Äôs plan smart ü§ù");
}

/* ========================
   EVENTS
   ======================== */
UI.themeBtn.onclick = ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'light';
  const next = cur==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem(LS_KEYS.theme, next);
  UI.themeBtn.textContent = next==='dark'?'‚òÄÔ∏è':'üåô';
};
UI.resetBtn.onclick = ()=>{
  if(confirm('Reset everything and start planning again?')){
    resetAll();
  }
};
UI.backPlanningBtn.onclick = ()=>{ renderPlanner(); scheduleAI(); };

['#p_name','#p_grade','#p_homeState','#p_income','#p_gpa','#p_sat','#p_ap','#p_pref','#p_interest'].forEach(sel=>{
  const el = $(sel);
  el.addEventListener('input', previewMatches);
  el.addEventListener('change', previewMatches);
});
$('#p_states').addEventListener('change', previewMatches);

UI.startBtn.onclick = ()=>{
  const name = $('#p_name').value.trim();
  const grade = $('#p_grade').value;
  const home = $('#p_homeState').value;
  if(!name || !grade || !home){
    aiPing('Name, grade, and home state are required to tailor results üìå');
    return;
  }
  const sel = $('#p_states');
  user = {
    name,
    grade,
    homeState: home,
    householdIncome: Number($('#p_income').value||0),
    gpa: Number($('#p_gpa').value||0),
    sat: Number($('#p_sat').value||0),
    ap: Number($('#p_ap').value||0),
    pref: $('#p_pref').value||'',
    interest: $('#p_interest').value||'',
    targetStates: Array.from(sel.selectedOptions).map(o=>o.value),
    email: $('#p_email').value||''
  };
  saveAll();
  renderDashboard();
  scheduleAI();
};

// tab clicks
UI.tabs.forEach(tab=>{
  tab.addEventListener('click', ()=> setActiveTab(tab.dataset.tab));
});

// filter listeners
UI.filters.state.onchange = ()=>renderSchoolsTab();
UI.filters.sys.onchange = ()=>renderSchoolsTab();
UI.filters.q.oninput = ()=>renderSchoolsTab();

// AI bubble click ‚Üí helpful action
UI.aiBubble.onclick = ()=>{
  if(UI.planner.classList.contains('hidden')){
    if(mySchools.length===0){
      setActiveTab('schools'); aiPing('Tap ‚ÄúAdd‚Äù on a few schools ‚Äî I‚Äôll build docs & deadlines automatically.');
    }else{
      setActiveTab('aid'); aiPing('I estimated your grants; select a school to see a breakdown.');
    }
  }else{
    aiPing('Pick home state + income; I‚Äôll auto-calc resident costs and aid later.');
  }
};

/* Preview match count while planning (safe if user is null) */
function previewMatches(){
  const tempUser = {
    gpa: Number($('#p_gpa').value||0),
    sat: Number($('#p_sat').value||0),
    ap: Number($('#p_ap').value||0),
    pref: $('#p_pref').value||'',
    interest: $('#p_interest').value||'',
    homeState: $('#p_homeState').value||'',
    targetStates: Array.from($('#p_states').selectedOptions).map(o=>o.value)
  };
  const prev = user;
  user = { ...(user||{}), ...tempUser };           // safe when user is null
  const allowStates = (tempUser.targetStates && tempUser.targetStates.length>0)
    ? new Set(tempUser.targetStates) : null;
  const count = SCHOOLS
    .filter(s=> !allowStates || allowStates.has(s.state))
    .filter(s=> matchScore(s) > 50).length;
  UI.matchPreview.textContent = `${count} potential matches`;
  user = prev;
}

/* ========================
   INIT
   ======================== */
(function init(){
  loadAll();
  const t = localStorage.getItem(LS_KEYS.theme) || 'light';
  document.documentElement.setAttribute('data-theme', t);
  UI.themeBtn.textContent = t==='dark'?'‚òÄÔ∏è':'üåô';

  if(user){ renderDashboard(); }
  else{ renderPlanner(); }

  scheduleAI();
  runTests(); // unit tests log to console
})();

/* ========================
   UNIT TESTS (tiny harness)
   ======================== */
function assert(cond, msg){ if(!cond) throw new Error(msg); }
function runTests(){
  try{
    const sampleUser = {gpa:4.1,sat:1500,ap:8,pref:'reputation',interest:'stem',homeState:'CA'};
    const prev = user; user = sampleUser;
    const stan = SCHOOLS.find(s=>s.id==='stan');
    const ucsc = SCHOOLS.find(s=>s.id==='ucsc');
    assert(bucketFor(stan)==='reach' || bucketFor(stan)==='match', 'Stanford should not be safety');
    assert(bucketFor(ucsc)!=='reach', 'UCSC should be match/safety for strong profile');

    const tl = [
      ...makeDocsForSchool(SCHOOLS.find(s=>s.id==='ucla')),
      ...makeDocsForSchool(SCHOOLS.find(s=>s.id==='ucb')),
    ];
    assert(tl.some(x=>x.label.includes('transcript')), 'Docs include transcripts');
    assert(tl.some(x=>x.label.includes('essays')), 'Docs include essays');
    user = prev;
    console.log('%cTests passed ‚úì', 'color: #16a34a; font-weight:700');
  }catch(e){
    console.error('Tests failed:', e.message);
  }
}

/* =========================
   Native Bridge ‚Üí App wiring
   ========================= */
window.__pw_reset = function () {
  try { resetAll(); } catch (e) { console.warn('__pw_reset issue', e); }
};

window.__pw_nav = function (dest) {  // 'planner' | 'dashboard'
  try {
    if (dest === 'planner') renderPlanner();
    else renderDashboard();
  } catch (e) { console.warn('__pw_nav issue', e); }
};

window.__pw_setUser = function (u) {
  try {
    user = { ...(user||{}), ...(u||{}) };
    saveAll();
    renderDashboard();
  } catch (e) { console.warn('__pw_setUser issue', e); }
};

window.__pw_selectSchools = function (ids) {
  try {
    mySchools = Array.isArray(ids) ? ids.slice(0) : [];
    saveAll();
    renderSchoolsTab(); renderAidTab(); renderDocsTab(); renderTimelineTab();
  } catch (e) { console.warn('__pw_selectSchools issue', e); }
};

window.__pw_getState = function () {
  try { return JSON.stringify({ user, mySchools, docState }); }
  catch (e) { return "{}"; }
};
</script>
</body>
</html>
